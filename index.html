<!-- 檔名：SeafoodBossApp_v8.0.html -->
<!-- 版本：v8.0 (Final Architecture & Scroll Fix) -->
<!-- 修正：
     1. CSS修正：加入 #root { height: 100%; }，這是解決手機無法滑動的關鍵。
     2. 營運中心：月曆與流水帳整合在同一個 ScrollView，手感順暢。
     3. 首頁底部：監控區(灰)與計時區(白)視覺分層。
     4. 監控邏輯：未完成顯色(粉紅)，完成取消色塊(變透明)。
     5. 計時提醒：加入 Beep 音效。
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SEAFOOD.BOSS v8.0</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#F8FAFC"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <!-- 外部資源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 50: '#F8FAFC', 100: '#F1F5F9', 200: '#E2E8F0', 300: '#CBD5E1', 400: '#94A3B8', 500: '#64748B', 600: '#475569', 700: '#334155', 800: '#1E293B' },
                        sky: { 50: '#F0F9FF', 100: '#E0F2FE', 500: '#0EA5E9', 600: '#0284C7' },     
                        rose: { 50: '#FFF1F2', 100: '#FFE4E6', 500: '#F43F5E' },                    
                        emerald: { 50: '#ECFDF5', 100: '#D1FAE5', 500: '#10B981' },                 
                        orange: { 50: '#FFF7ED', 500: '#F97316' }, 
                        violet: { 50: '#F5F3FF', 100: '#EDE9FE', 500: '#8B5CF6' }
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'top': '0 -4px 6px -1px rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* 關鍵修正：確保 body 和 root 都是 100% 高度，內部滾動才能生效 */
        html, body, #root {
            height: 100%;
            overflow: hidden;
        }

        body {
            background-color: #F8FAFC; 
            color: #334155;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            position: fixed; inset: 0; 
            user-select: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-top: 60px; /* Header Height */
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .todo-checkbox {
            appearance: none; width: 1.2rem; height: 1.2rem;
            border: 2px solid #CBD5E1; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: white;
        }
        .todo-checkbox:checked { background-color: #F43F5E; border-color: #F43F5E; }
        .todo-checkbox:checked::after { content: '✔'; color: white; font-size: 0.8rem; }
        
        .capsule-btn { 
            border-width: 2px; 
            transition: all 0.2s; 
            background: transparent;
        }
        .capsule-btn:active { transform: scale(0.95); background: #F1F5F9; }
        
        /* 底部安全區 */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root">
        <div class="flex flex-col items-center justify-center h-screen bg-slate-50 text-slate-400 text-sm">
            <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-3 text-sky-500"></i>
            <p>系統載入中...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // DB Keys
        const DB_KEY_TRANSACTIONS = 'sf_transactions'; 
        const DB_KEY_LOGS = 'sf_logs';                 
        const DB_KEY_SETTINGS = 'sf_settings';         
        const DB_KEY_ENV = 'sf_daily_env';             
        const DB_KEY_TODOS = 'sf_todos_advanced_v1'; 

        // Utils
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        const formatTime = () => new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute:'2-digit' });
        const getCalendarDays = (year, month) => {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            let days = [];
            for(let i=0; i<firstDay.getDay(); i++) days.push(null);
            for(let i=1; i<=lastDay.getDate(); i++) {
                days.push({ day: i, dateStr: `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}` });
            }
            return days;
        };
        const useVoiceInput = (onResult) => {
            const [isListening, setIsListening] = useState(false);
            const startListening = () => {
                if (!('webkitSpeechRecognition' in window)) { alert("請使用 Chrome 瀏覽器"); return; }
                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'zh-TW'; recognition.continuous = false; recognition.interimResults = false;
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => { onResult(event.results[0][0].transcript); };
                recognition.start();
            };
            return { isListening, startListening };
        };

        // Audio Beep Function
        const playBeep = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.value = 880; // A5
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.start();
                osc.stop(ctx.currentTime + 0.5); // Beep for 0.5s
            } catch (e) { console.error("Audio play failed", e); }
        };

        // --- Shared Components ---

        const Header = ({ title, showBack, onBack, themeColor }) => (
            <div className={`fixed top-0 left-0 right-0 h-[60px] z-50 flex items-center justify-between px-5 ${showBack ? 'glass-header' : 'bg-transparent'}`}>
                {showBack && (
                    <div className="flex items-center gap-3 w-full">
                         <button onClick={onBack} className="w-8 h-8 rounded-full bg-white/80 border border-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition-transform shadow-sm">
                            <i className="fa-solid fa-chevron-left"></i>
                        </button>
                        <h1 className={`text-base font-bold tracking-wide absolute left-1/2 -translate-x-1/2 ${themeColor}`}>{title}</h1>
                    </div>
                )}
            </div>
        );

        // --- Pages ---

        // 1. Home Matrix (Revised Bottom Console)
        const HomeMatrix = ({ setPage, todos, activeTimer, startTimer, stopTimer }) => {
            const todayStr = getTodayStr();
            const todayTodos = todos.filter(t => t.date === todayStr);
            const pendingCount = todayTodos.filter(t => !t.done).length;
            
            const timerCapsules = [
                { min: 10, activeClass: 'bg-emerald-500 text-white border-emerald-500', inactiveClass: 'border-slate-300 text-slate-500' },
                { min: 15, activeClass: 'bg-orange-500 text-white border-orange-500', inactiveClass: 'border-slate-300 text-slate-500' },
                { min: 20, activeClass: 'bg-rose-500 text-white border-rose-500', inactiveClass: 'border-slate-300 text-slate-500' },
            ];

            return (
                <div className="h-full flex flex-col p-6 animate-fade-in relative bg-slate-50">
                    
                    {/* 1. Top Center Logo (v8.0) */}
                    <div className="flex flex-col items-center justify-center pt-8 pb-4">
                        <div className="w-16 h-16 rounded-2xl bg-sky-50 flex items-center justify-center shadow-sm border border-sky-100 mb-2">
                            <i className="fa-solid fa-fish text-sky-600 text-3xl"></i>
                        </div>
                        <div className="flex flex-col items-center">
                            <span className="text-2xl font-black text-slate-800 tracking-wide leading-none">SEAFOOD<span className="text-sky-500">.BOSS</span></span>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="text-xs text-slate-400 font-bold tracking-wider">PROFESSIONAL</span>
                                <span className="text-[10px] text-white bg-slate-300 px-1.5 py-0.5 rounded font-mono">v8.0</span>
                            </div>
                        </div>
                    </div>

                    {/* 2. Main Matrix */}
                    <div className="flex-1 grid grid-cols-2 gap-4 w-full mb-36 content-start">
                        
                        {/* 內部營運 (Blue) */}
                        <button onClick={() => setPage('ops')} className="bg-sky-50 rounded-3xl border border-sky-100 shadow-sm flex flex-col items-center justify-center active:scale-[0.98] transition-all aspect-square">
                            <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center mb-3 text-sky-600 shadow-sm">
                                <i className="fa-solid fa-calculator text-2xl"></i>
                            </div>
                            <span className="text-base font-bold text-sky-700">內部營運</span>
                        </button>

                        {/* 待辦事項 (Pink) */}
                        <button onClick={() => setPage('todo')} className="bg-rose-50 rounded-3xl border border-rose-100 shadow-sm flex flex-col items-center justify-center active:scale-[0.98] transition-all relative aspect-square">
                            {pendingCount > 0 && (
                                <div className="absolute top-4 right-4 w-3 h-3 bg-rose-500 rounded-full border-2 border-white animate-pulse"></div>
                            )}
                            <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center mb-3 text-rose-500 shadow-sm">
                                <i className="fa-solid fa-list-check text-2xl"></i>
                            </div>
                            <span className="text-base font-bold text-rose-700">待辦事項</span>
                            {pendingCount > 0 && <span className="text-[10px] text-rose-500 font-bold mt-1">{pendingCount} 筆未結</span>}
                        </button>

                        {/* 營運筆記 (Green) */}
                        <button onClick={() => setPage('note')} className="bg-emerald-50 rounded-3xl border border-emerald-100 shadow-sm flex flex-col items-center justify-center active:scale-[0.98] transition-all aspect-square">
                            <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center mb-3 text-emerald-500 shadow-sm">
                                <i className="fa-solid fa-pen-to-square text-2xl"></i>
                            </div>
                            <span className="text-base font-bold text-emerald-700">營運筆記</span>
                        </button>

                        {/* AI 秘書 (Purple) */}
                        <button onClick={() => setPage('ai')} className="bg-violet-50 rounded-3xl border border-violet-100 shadow-sm flex flex-col items-center justify-center active:scale-[0.98] transition-all aspect-square">
                            <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center mb-3 text-violet-500 shadow-sm">
                                <i className="fa-solid fa-robot text-2xl"></i>
                            </div>
                            <span className="text-base font-bold text-violet-700">AI 智慧秘書</span>
                            <span className="text-[10px] text-violet-400 font-bold mt-1 bg-white/50 px-2 rounded-full">訂閱服務</span>
                        </button>
                    </div>

                    {/* 3. Bottom Control Console (Dual Layer: Monitor & Timer) */}
                    <div className="fixed bottom-0 left-0 right-0 z-50 flex flex-col shadow-top">
                        
                        {/* Upper Layer: Dashboard Monitor (Grey Background) */}
                        <div className="bg-slate-50 border-t border-slate-200 px-6 py-2 flex items-center justify-between h-10">
                            <div className="flex items-center gap-2 text-slate-400">
                                <i className="fa-solid fa-bell text-xs animate-pulse"></i>
                                <span className="text-[10px] font-bold tracking-wider">今日待辦監控</span>
                            </div>
                            <div className="flex gap-1.5">
                                {todayTodos.length === 0 ? (
                                    <span className="text-[10px] text-slate-300 font-mono">NO TASKS</span>
                                ) : (
                                    todayTodos.map((t, i) => (
                                        // 邏輯修正：未完成顯示粉紅，完成顯示透明空心框(取消色塊)
                                        <div key={i} className={`w-3 h-3 rounded-sm transition-all duration-500 ${t.done ? 'bg-transparent border border-rose-100' : 'bg-rose-500 shadow-sm'}`}></div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Lower Layer: Timer Controls (White Background) */}
                        <div className="bg-white pb-safe pt-4 pb-4 flex flex-col items-center shadow-lg relative z-20">
                            <div className="flex gap-4 items-center justify-center w-full px-6 mb-2">
                                {timerCapsules.map((t) => {
                                    const isActive = activeTimer && activeTimer.minutes === t.min;
                                    return (
                                        <button 
                                            key={t.min} 
                                            onClick={() => isActive ? stopTimer() : startTimer(t.min)}
                                            className={`capsule-btn w-24 h-10 rounded-full flex items-center justify-center text-lg font-bold ${isActive ? t.activeClass : t.inactiveClass}`}
                                            style={{ borderStyle: 'solid' }}
                                        >
                                            {isActive ? <i className="fa-solid fa-pause text-sm"></i> : t.min}
                                        </button>
                                    );
                                })}
                            </div>
                            <div className="text-center">
                                <span className={`text-[10px] font-bold ${activeTimer ? 'text-orange-500 animate-pulse' : 'text-slate-400'}`}>
                                    {activeTimer ? '計時進行中...' : '暫離提醒'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Operations Page (FIX: Single Scroll Container for Calendar & List)
        const OperationsPage = ({ transactions, setTransactions, settings, saveSettings, envData, setEnvData }) => {
            const [period, setPeriod] = useState('day'); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSettingModal, setShowSettingModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedDate, setSelectedDate] = useState(getTodayStr());
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
            
            // Form State
            const [date, setDate] = useState(getTodayStr());
            const [type, setType] = useState('income');
            const [amount, setAmount] = useState('');
            const [cat, setCat] = useState('現金');
            const [note, setNote] = useState('');
            const [tempFixedCost, setTempFixedCost] = useState(settings.dailyFixedCost || '');
            const [selectedCostItems, setSelectedCostItems] = useState(settings.costItems || []);

            const costOptions = ['房租', '人事', '水電', '食材耗損', '雜支'];
            const toggleCostItem = (item) => { 
                if(selectedCostItems.includes(item)) setSelectedCostItems(selectedCostItems.filter(i => i !== item)); 
                else setSelectedCostItems([...selectedCostItems, item]); 
            };

            const currentEnv = envData[selectedDate] || { weather: 'sunny', traffic: 'normal' };
            const updateEnv = (key, value) => { const newEnv = { ...envData, [selectedDate]: { ...currentEnv, [key]: value } }; setEnvData(newEnv); localStorage.setItem(DB_KEY_ENV, JSON.stringify(newEnv)); };

            const stats = useMemo(() => {
                const now = new Date(); const yearStr = now.getFullYear().toString(); const monthStr = `${yearStr}-${String(currentMonth).padStart(2, '0')}`;
                let filtered = [], fixedCostTotal = 0, listData = [], net = 0, income = 0, expense = 0;
                const dailyStats = {}; 
                transactions.forEach(t => {
                    if(!dailyStats[t.date]) dailyStats[t.date] = { income: 0, expense: 0 };
                    if(t.type === 'income') dailyStats[t.date].income += t.amount; else dailyStats[t.date].expense += t.amount;
                });
                const dailyCost = settings.dailyFixedCost || 0;
                if (period === 'day') { filtered = transactions.filter(t => t.date === selectedDate); fixedCostTotal = dailyCost; listData = filtered; } 
                else if (period === 'month') { filtered = transactions.filter(t => t.date.startsWith(monthStr)); const daysInM = new Date(now.getFullYear(), currentMonth, 0).getDate(); fixedCostTotal = dailyCost * daysInM; listData = transactions.filter(t => t.date === selectedDate); } 
                else { filtered = transactions.filter(t => t.date.startsWith(yearStr)); fixedCostTotal = dailyCost * 365; }
                income = filtered.filter(t => t.type === 'income').reduce((a,c) => a+c.amount, 0); expense = filtered.filter(t => t.type === 'expense').reduce((a,c) => a+c.amount, 0); net = income - expense - fixedCostTotal;
                if(period !== 'year') listData.sort((a,b) => b.id - a.id);
                return { income, expense, fixedCostTotal, net, listData, dailyStats };
            }, [transactions, settings, period, selectedDate, currentMonth]);

            const calendarDays = useMemo(() => getCalendarDays(new Date().getFullYear(), currentMonth), [currentMonth]);

            const handleSave = () => { if (!amount) return; let updated; if (editingId) { updated = transactions.map(t => t.id === editingId ? { ...t, date, amount: parseInt(amount), type, category: cat, note } : t); } else { const newTrans = { id: Date.now(), date: date, amount: parseInt(amount), type, category: cat, note, timestamp: formatTime() }; updated = [newTrans, ...transactions]; } setTransactions(updated); localStorage.setItem(DB_KEY_TRANSACTIONS, JSON.stringify(updated)); resetForm(); };
            const handleDelete = () => { if (!editingId) return; if (!confirm('確定刪除？')) return; const updated = transactions.filter(t => t.id !== editingId); setTransactions(updated); localStorage.setItem(DB_KEY_TRANSACTIONS, JSON.stringify(updated)); resetForm(); };
            const resetForm = () => { setAmount(''); setNote(''); setEditingId(null); setShowAddModal(false); };
            const openEdit = (item) => { setEditingId(item.id); setDate(item.date); setType(item.type); setAmount(item.amount); setCat(item.category); setNote(item.note); setShowAddModal(true); };

            const TrafficBtn = ({ val, label, activeClass, inactiveClass }) => (
                <button onClick={() => updateEnv('traffic', val)} className={`flex-1 py-1 rounded text-xs font-bold transition-all border ${currentEnv.traffic === val ? activeClass : inactiveClass}`}>
                    {label}
                </button>
            );

            return (
                <div className="h-full bg-sky-50 flex flex-col pt-[60px]">
                    {/* Fixed Top Part (Controls Only) */}
                    <div className="flex-none p-4 pb-2 shadow-sm border-b border-sky-100 bg-sky-50 z-10">
                        <div className="flex justify-between items-center mb-3">
                            <div className="bg-white p-1 rounded-lg border border-sky-100 inline-flex shadow-sm">
                                {['day', 'month', 'year'].map(p => (
                                    <button key={p} onClick={() => setPeriod(p)} className={`px-3 py-1 rounded text-xs font-bold transition-all ${period === p ? 'bg-sky-500 text-white' : 'text-slate-400'}`}>{p === 'day' ? '日' : p === 'month' ? '月' : '年'}</button>
                                ))}
                            </div>
                            {period === 'day' && <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="bg-white border border-sky-100 text-sky-600 text-xs font-bold py-1 px-2 rounded focus:outline-none shadow-sm" />}
                            {period === 'month' && (
                                <div className="flex items-center space-x-2 bg-white px-2 py-1 rounded border border-sky-100 shadow-sm">
                                    <button onClick={() => setCurrentMonth(p => p===1?12:p-1)} className="text-sky-500"><i className="fa-solid fa-chevron-left text-xs"></i></button>
                                    <span className="text-xs font-bold text-slate-700 w-8 text-center">{currentMonth}月</span>
                                    <button onClick={() => setCurrentMonth(p => p===12?1:p+1)} className="text-sky-500"><i className="fa-solid fa-chevron-right text-xs"></i></button>
                                </div>
                            )}
                            <button onClick={() => setShowSettingModal(true)} className="w-8 h-8 rounded-full bg-white border border-sky-100 text-sky-500 flex items-center justify-center active:scale-95 shadow-sm"><i className="fa-solid fa-gear"></i></button>
                        </div>

                        <div className="bg-sky-600 rounded-xl p-4 shadow-lg text-white mb-3 relative overflow-hidden">
                            <div className="absolute right-0 top-0 p-4 opacity-10 text-white"><i className="fa-solid fa-chart-line text-6xl"></i></div>
                            <div className="relative z-10 flex justify-between items-center">
                                <div>
                                    <div className="text-[10px] text-sky-200 font-bold tracking-wider mb-1">淨利結餘</div>
                                    <div className={`text-2xl font-black ${stats.net >= 0 ? 'text-white' : 'text-rose-200'}`}>{stats.net > 0 ? '+' : ''}{stats.net.toLocaleString()}</div>
                                </div>
                                <div className="text-right space-y-1">
                                    <div className="text-xs"><span className="text-sky-200 mr-2">進</span> <span className="text-emerald-300 font-bold">+{stats.income.toLocaleString()}</span></div>
                                    <div className="text-xs"><span className="text-sky-200 mr-2">出</span> <span className="text-rose-300 font-bold">-{stats.expense.toLocaleString()}</span></div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3 mb-2">
                            <button onClick={() => {setType('income'); setCat('現金'); setDate(selectedDate); resetForm(); setShowAddModal(true);}} className="bg-white text-emerald-600 border border-emerald-100 py-3 rounded-lg font-bold shadow-sm flex items-center justify-center text-sm active:scale-95"><i className="fa-solid fa-plus mr-2"></i> 記進帳</button>
                            <button onClick={() => {setType('expense'); setCat('進貨'); setDate(selectedDate); resetForm(); setShowAddModal(true);}} className="bg-white text-rose-500 border border-rose-100 py-3 rounded-lg font-bold shadow-sm flex items-center justify-center text-sm active:scale-95"><i className="fa-solid fa-minus mr-2"></i> 記出帳</button>
                        </div>
                        
                         {period === 'day' && (
                            <div className="flex items-center gap-2">
                                <div className="flex space-x-1 bg-white p-1 rounded-lg border border-sky-100 shadow-sm">
                                    {['sunny','cloudy','rainy'].map(w => (
                                        <button key={w} onClick={() => updateEnv('weather', w)} className={`w-6 h-6 rounded flex items-center justify-center transition-all ${currentEnv.weather === w ? 'bg-sky-500 text-white' : 'text-slate-300'}`}><i className={`fa-solid fa-${w === 'sunny' ? 'sun' : w === 'cloudy' ? 'cloud' : 'cloud-showers-heavy'} text-xs`}></i></button>
                                    ))}
                                </div>
                                <div className="flex gap-1 flex-1">
                                    <TrafficBtn val="slow" label="冷清" activeClass="bg-sky-500 text-white border-sky-500" inactiveClass="bg-white text-slate-400 border-slate-200" />
                                    <TrafficBtn val="normal" label="正常" activeClass="bg-orange-500 text-white border-orange-500" inactiveClass="bg-white text-slate-400 border-slate-200" />
                                    <TrafficBtn val="busy" label="爆滿" activeClass="bg-rose-500 text-white border-rose-500" inactiveClass="bg-white text-slate-400 border-slate-200" />
                                </div>
                            </div>
                        )}
                    </div>

                    {/* SCROLLABLE BOTTOM PART: Calendar AND List scroll together */}
                    {/* KEY FIX: flex-1, overflow-y-auto, containing BOTH calendar and list */}
                    <div className="flex-1 overflow-y-auto p-4 pt-2 pb-20">
                        
                        {/* Calendar - Inserted HERE inside scroll container */}
                        {period === 'month' && (
                            <div className="mb-4 bg-white rounded-xl p-3 border border-sky-100 shadow-sm mt-2 animate-fade-in">
                                <div className="mb-2 text-center text-xs font-bold text-sky-500">本月概況</div>
                                <div className="grid grid-cols-7 gap-1 mb-2 text-center">{['日','一','二','三','四','五','六'].map(d => <span key={d} className="text-[10px] text-slate-400 font-bold">{d}</span>)}</div>
                                <div className="grid grid-cols-7 gap-1">
                                    {calendarDays.map((d, i) => {
                                        if(!d) return <div key={i}></div>;
                                        const s = stats.dailyStats[d.dateStr];
                                        const hasData = s && (s.income > 0 || s.expense > 0);
                                        const isSelected = selectedDate === d.dateStr;
                                        return (
                                            <div key={i} onClick={() => setSelectedDate(d.dateStr)} className={`aspect-square flex flex-col items-center justify-center rounded-lg cursor-pointer border transition-colors ${isSelected ? 'bg-sky-500 text-white border-sky-500' : 'border-transparent hover:bg-sky-50 text-slate-500'}`}>
                                                <span className="text-xs font-bold">{d.day}</span>
                                                <div className={`w-1 h-1 rounded-full mt-0.5 ${hasData ? (isSelected ? 'bg-white' : 'bg-emerald-500') : 'opacity-0'}`}></div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        <div className="mt-2">
                             <div className="flex items-center gap-2 mb-2 px-1">
                                <div className="w-1 h-4 bg-sky-400 rounded-full"></div>
                                <span className="text-xs font-bold text-slate-500">流水帳明細 ({selectedDate})</span>
                            </div>

                            {stats.listData.length === 0 ? (
                                <div className="text-center py-10 opacity-40 text-slate-400"><i className="fa-solid fa-clipboard-list text-2xl mb-2"></i><p className="text-xs">本日無帳務</p></div>
                            ) : (
                                stats.listData.map((item, idx) => (
                                    <div key={idx} onClick={() => openEdit(item)} className="bg-white p-3 rounded-lg flex justify-between items-center mb-2 shadow-sm border-l-2 border-sky-100 active:bg-sky-50 cursor-pointer">
                                        <div className="flex items-center">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 ${item.type === 'income' ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}`}>
                                                <i className={`fa-solid ${item.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'} text-xs`}></i>
                                            </div>
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-slate-700 text-sm">{item.category}</span>
                                                    <span className="text-[10px] text-slate-400 bg-slate-100 px-1 rounded">{item.timestamp?.slice(0,5)}</span>
                                                </div>
                                                {item.note && <p className="text-xs text-slate-400 truncate max-w-[150px]">{item.note}</p>}
                                            </div>
                                        </div>
                                        <span className={`font-mono font-bold text-base ${item.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}`}>{item.type === 'income' ? '+' : '-'}{item.amount.toLocaleString()}</span>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {showAddModal && (
                        <div className="fixed inset-0 bg-slate-900/40 z-[200] flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-t-2xl sm:rounded-xl w-full max-w-sm p-6 shadow-2xl animate-slide-up">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-xl text-slate-700">{editingId ? '編輯紀錄' : (type === 'income' ? '新增進帳' : '新增支出')}</h3>
                                    {editingId && <button onClick={handleDelete} className="text-rose-500 font-bold text-sm"><i className="fa-solid fa-trash mr-1"></i>刪除</button>}
                                </div>
                                <div className="space-y-4">
                                    <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full bg-slate-50 text-slate-700 p-3 rounded-lg font-bold outline-none border border-slate-200 focus:border-slate-400" />
                                    <div className="relative">
                                        <span className="absolute left-0 top-2 text-2xl font-bold text-slate-400">$</span>
                                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full pl-6 text-4xl font-black bg-transparent border-b border-slate-200 py-2 outline-none text-slate-800 placeholder-slate-200" placeholder="0" autoFocus />
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {(type === 'income' ? ['現金', '刷卡', '外送平台', '其他'] : ['進貨', '人事', '雜支', '修繕', '房租']).map(c => (
                                            <button key={c} onClick={() => setCat(c)} className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${cat === c ? 'bg-sky-600 text-white border-sky-600' : 'bg-white text-slate-500 border-slate-200'}`}>{c}</button>
                                        ))}
                                    </div>
                                    <input type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full bg-slate-50 text-slate-700 rounded-lg p-3 text-sm outline-none border border-slate-200 focus:border-slate-400" placeholder="備註..." />
                                    <div className="flex gap-3 mt-4">
                                        <button onClick={() => setShowAddModal(false)} className="flex-1 py-3 text-slate-500 bg-slate-100 rounded-lg font-bold">取消</button>
                                        <button onClick={handleSave} className="flex-1 py-3 bg-sky-500 text-white rounded-lg font-bold shadow-md">確認</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettingModal && (
                        <div className="fixed inset-0 bg-slate-900/50 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
                                <h3 className="font-bold text-lg mb-2 text-slate-700">營運成本設定</h3>
                                <p className="text-xs text-slate-400 mb-4">勾選項目並輸入每日攤提總額</p>
                                
                                <div className="flex flex-wrap gap-2 mb-6">
                                    {costOptions.map(item => (
                                        <button key={item} onClick={() => toggleCostItem(item)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors ${selectedCostItems.includes(item) ? 'bg-sky-600 text-white border-sky-600' : 'bg-white text-slate-400 border-slate-200'}`}>
                                            {selectedCostItems.includes(item) && <i className="fa-solid fa-check mr-1"></i>}{item}
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="relative mb-6">
                                    <span className="absolute left-0 top-3 text-xl font-bold text-slate-400">$</span>
                                    <input type="number" value={tempFixedCost} onChange={e => setTempFixedCost(e.target.value)} className="w-full pl-6 text-3xl font-black border-b-2 border-slate-200 py-2 focus:outline-none text-slate-700 placeholder-slate-200" placeholder="0" />
                                </div>
                                
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSettingModal(false)} className="flex-1 py-3 text-slate-500 font-bold bg-slate-100 rounded-lg">取消</button>
                                    <button onClick={() => { 
                                        saveSettings({...settings, dailyFixedCost: parseInt(tempFixedCost) || 0, costItems: selectedCostItems}); 
                                        setShowSettingModal(false); 
                                    }} className="flex-1 py-3 bg-sky-500 text-white rounded-lg font-bold">儲存</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 3. Todo Page (Today's Tasks)
        const TodoPage = ({ todos, setTodos }) => {
            const categories = ['進料', '款項', '員工', '修繕', '其他'];
            const [dateTab, setDateTab] = useState('today');
            const [activeCat, setActiveCat] = useState('進料');
            const [itemInput, setItemInput] = useState('');
            const { isListening, startListening } = useVoiceInput((text) => setItemInput(prev => prev + text));
            const todayStr = getTodayStr();
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            const targetDate = dateTab === 'today' ? todayStr : tomorrowStr;
            const filteredTodos = todos.filter(t => t.date === targetDate);
            const addTodo = () => { if(!itemInput.trim()) return; const newItem = { id: Date.now(), text: itemInput, category: activeCat, done: false, date: targetDate }; const updated = [newItem, ...todos]; setTodos(updated); localStorage.setItem(DB_KEY_TODOS, JSON.stringify(updated)); setItemInput(''); };
            const toggleDone = (id) => { const updated = todos.map(t => t.id === id ? { ...t, done: !t.done } : t); setTodos(updated); localStorage.setItem(DB_KEY_TODOS, JSON.stringify(updated)); };
            const deleteTodo = (id) => { const updated = todos.filter(t => t.id !== id); setTodos(updated); localStorage.setItem(DB_KEY_TODOS, JSON.stringify(updated)); };

            return (
                <div className="page-container bg-rose-50 animate-slide-up">
                    <div className="fixed-controls px-4 pt-4 pb-2 bg-rose-50 sticky top-0 z-10">
                        <div className="flex bg-white p-1 rounded-xl mb-3 border border-rose-100 shadow-sm">
                            <button onClick={() => setDateTab('today')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${dateTab === 'today' ? 'bg-rose-500 text-white shadow' : 'text-slate-400'}`}>今日待辦</button>
                            <button onClick={() => setDateTab('tomorrow')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${dateTab === 'tomorrow' ? 'bg-orange-400 text-white shadow' : 'text-slate-400'}`}>明日預排</button>
                        </div>
                        
                        <div className="bg-white p-3 rounded-xl border border-rose-100 shadow-sm mb-2">
                            <div className="flex gap-2 overflow-x-auto no-scrollbar mb-2">
                                {categories.map(cat => (
                                    <button key={cat} onClick={() => setActiveCat(cat)} className={`px-3 py-1 rounded text-xs font-bold whitespace-nowrap transition-all ${activeCat === cat ? 'bg-rose-500 text-white' : 'bg-slate-100 text-slate-500'}`}>{cat}</button>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <input type="text" value={itemInput} onChange={e => setItemInput(e.target.value)} className="flex-1 bg-slate-50 rounded px-3 py-2 text-sm text-slate-700 focus:outline-none border border-slate-200 focus:border-rose-300" placeholder="任務名稱..." />
                                <button onClick={startListening} className={`w-10 rounded flex items-center justify-center shrink-0 ${isListening ? 'bg-rose-500 animate-pulse text-white' : 'bg-slate-100 text-slate-400'}`}><i className="fa-solid fa-microphone"></i></button>
                                <button onClick={addTodo} className="w-10 rounded bg-rose-500 text-white flex items-center justify-center"><i className="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto px-4 pb-20">
                        <div className="space-y-2">
                            {filteredTodos.map(item => (
                                <div key={item.id} className={`flex items-start p-3 rounded-lg border transition-all ${item.done ? 'bg-white/50 border-transparent opacity-50' : 'bg-white border-rose-100 shadow-sm'}`}>
                                    <input type="checkbox" checked={item.done} onChange={() => toggleDone(item.id)} className="todo-checkbox shrink-0 mr-3 mt-1 cursor-pointer" />
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] text-rose-500 bg-rose-50 px-1 rounded font-bold">{item.category}</span>
                                            <span className={`text-sm font-bold truncate ${item.done ? 'line-through text-slate-400' : 'text-slate-700'}`}>{item.text}</span>
                                        </div>
                                    </div>
                                    <button onClick={() => deleteTodo(item.id)} className="text-slate-300 hover:text-rose-500 px-2"><i className="fa-solid fa-xmark"></i></button>
                                </div>
                            ))}
                            {filteredTodos.length === 0 && <div className="text-center text-slate-300 text-xs py-10">無待辦事項</div>}
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Note Page (Green Theme)
        const NotePage = ({ logs, setLogs }) => {
            const [input, setInput] = useState('');
            const { isListening, startListening } = useVoiceInput((text) => setInput(prev => prev + text));
            const add = () => { if(!input.trim()) return; const n={id:Date.now(), date:getTodayStr(), timestamp:formatTime(), text:input}; const u=[n,...logs]; setLogs(u); localStorage.setItem(DB_KEY_LOGS, JSON.stringify(u)); setInput(''); };
            const del = (id) => { const u=logs.filter(l=>l.id!==id); setLogs(u); localStorage.setItem(DB_KEY_LOGS, JSON.stringify(u)); };
            return (
                <div className="page-container bg-emerald-50 animate-slide-up">
                    <div className="fixed-controls px-4 pt-4 pb-2 bg-emerald-50">
                        <div className="flex gap-2">
                            <input value={input} onChange={e=>setInput(e.target.value)} placeholder="輸入筆記..." className="flex-1 bg-white border border-emerald-100 text-slate-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-emerald-400 shadow-sm" />
                            <button onClick={startListening} className="w-10 rounded-lg bg-white border border-slate-200 text-slate-400"><i className="fa-solid fa-microphone"></i></button>
                            <button onClick={add} className="w-12 rounded-lg bg-emerald-500 text-white font-bold shadow-sm"><i className="fa-solid fa-arrow-up"></i></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto px-4 pb-20">
                        <div className="space-y-3 pt-2">
                            {logs.map(l => (
                                <div key={l.id} className="bg-white p-3 rounded-lg border-l-4 border-emerald-400 shadow-sm relative group">
                                    <div className="text-[10px] text-emerald-600 font-mono mb-1">{l.date} {l.timestamp}</div>
                                    <div className="text-sm text-slate-700 whitespace-pre-wrap">{l.text}</div>
                                    <button onClick={() => del(l.id)} className="absolute right-2 top-2 text-slate-300 opacity-0 group-hover:opacity-100 hover:text-rose-500"><i className="fa-solid fa-times"></i></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 5. AI Page
        const AiPage = () => {
             return (
                <div className="page-container bg-violet-50 animate-slide-up items-center justify-center p-6 text-center pt-24">
                    <div className="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-soft mb-6 text-violet-500">
                        <i className="fa-solid fa-robot text-3xl"></i>
                    </div>
                    <h2 className="text-xl font-black text-slate-700 mb-2">AI 智慧顧問</h2>
                    <div className="bg-violet-200 text-violet-700 px-3 py-1 rounded-full text-xs font-bold mb-6 inline-block">訂閱制服務</div>
                    <p className="text-sm text-slate-500 max-w-xs leading-relaxed">
                        本功能為進階訂閱項目。<br/>提供自動化庫存預測與營運分析報告。
                    </p>
                    <button className="mt-8 px-6 py-3 bg-violet-600 text-white rounded-lg font-bold text-sm shadow-lg w-full max-w-xs">了解訂閱方案</button>
                </div>
             )
        }

        const App = () => {
            const [page, setPage] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [logs, setLogs] = useState([]);
            const [todos, setTodos] = useState([]);
            const [settings, setSettings] = useState({ dailyFixedCost: 0, costItems: [] });
            const [envData, setEnvData] = useState({});
            
            // Timer State
            const [activeTimer, setActiveTimer] = useState(null);

            useEffect(() => {
                const t = localStorage.getItem(DB_KEY_TRANSACTIONS); if(t) setTransactions(JSON.parse(t));
                const l = localStorage.getItem(DB_KEY_LOGS); if(l) setLogs(JSON.parse(l));
                const s = localStorage.getItem(DB_KEY_SETTINGS); if(s) setSettings(JSON.parse(s));
                const e = localStorage.getItem(DB_KEY_ENV); if(e) setEnvData(JSON.parse(e));
                const d = localStorage.getItem(DB_KEY_TODOS); if(d) setTodos(JSON.parse(d));
                
                if ("Notification" in window) Notification.requestPermission();
            }, []);

            const saveSettings = (n) => { setSettings(n); localStorage.setItem(DB_KEY_SETTINGS, JSON.stringify(n)); };

            const startTimer = (m) => { setActiveTimer({ minutes: m, startTime: Date.now(), alarmTriggered: false }); };
            const stopTimer = () => { setActiveTimer(null); };

            useEffect(() => {
                let interval;
                if (activeTimer) {
                    interval = setInterval(() => {
                        const elapsed = (Date.now() - activeTimer.startTime) / 1000;
                        if (elapsed >= activeTimer.minutes * 60 && !activeTimer.alarmTriggered) {
                            setActiveTimer(prev => ({ ...prev, alarmTriggered: true }));
                            // Alert Combo
                            playBeep();
                            if (Notification.permission === "granted") new Notification("SEAFOOD.BOSS", { body: "暫離時間結束！" });
                            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                            alert("時間到！請返回崗位");
                            stopTimer();
                        }
                    }, 1000);
                } return () => clearInterval(interval);
            }, [activeTimer]);

            const titles = { ops: '內部營運', todo: '待辦事項', note: '營運筆記', ai: '智慧秘書' };
            const themeColors = { ops: 'text-sky-600', todo: 'text-rose-500', note: 'text-emerald-500', ai: 'text-violet-500' };

            return (
                <div className="h-full w-full bg-slate-50 text-slate-700">
                    {page === 'home' ? (
                        <>
                            <Header showBack={false} />
                            <HomeMatrix setPage={setPage} todos={todos} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />
                        </>
                    ) : (
                        <>
                            <Header title={titles[page]} showBack={true} onBack={() => setPage('home')} themeColor={themeColors[page]} />
                            {page === 'ops' && <OperationsPage transactions={transactions} setTransactions={setTransactions} settings={settings} saveSettings={saveSettings} envData={envData} setEnvData={setEnvData} />}
                            {page === 'todo' && <TodoPage todos={todos} setTodos={setTodos} />}
                            {page === 'note' && <NotePage logs={logs} setLogs={setLogs} />}
                            {page === 'ai' && <AiPage />}
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        if (registration.active && !registration.active.scriptURL.includes('sw-v8.0.js')) {
                            registration.unregister();
                        }
                    }
                }).then(() => {
                    return navigator.serviceWorker.register('./sw-v8.0.js');
                });
            });
        }
    </script>
</body>
</html>