<!-- 檔名：index.html (v2.7 Stable Model Fix) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Seafood Boss (v2.7)</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0284c7"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: {
                            50: '#F0F9FF',
                            100: '#E0F2FE',
                            500: '#0EA5E9',
                            800: '#075985',
                            900: '#0C4A6E',
                        },
                        ocean: {
                            600: '#0284c7', // Sky 600
                            800: '#075985', // Sky 800
                        },
                        darkgray: '#374151',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #F8FAFC;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
            color: #374151;
        }
        .card-shadow { box-shadow: 0 4px 12px rgba(12, 74, 110, 0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes shrinkWidth {
            from { width: 100%; }
            to { width: 0%; }
        }
        .animate-progress {
            animation-name: shrinkWidth;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
        
        .bottom-nav-fix {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding-bottom: env(safe-area-inset-bottom);
            background-color: white;
            z-index: 50;
            border-top: 1px solid #F1F5F9;
        }
        .content-padding {
            padding-bottom: 90px; 
            padding-top: 60px; /* Space for Sticky Env Bar */
        }
        /* Sticky Elements */
        .sticky-env-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 60;
            background: linear-gradient(to right, #0284c7, #0369a1);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .sticky-sub-header {
            position: sticky;
            top: 60px; 
            z-index: 40;
            background-color: #F8FAFC;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // DB Keys
        const DB_KEY_TRANSACTIONS = 'sf_transactions'; 
        const DB_KEY_LOGS = 'sf_logs';                 
        const DB_KEY_SETTINGS = 'sf_settings';         
        const DB_KEY_ENV = 'sf_daily_env';             

        // --- Helpers ---
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        const formatTime = () => new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute:'2-digit' });
        
        const getCalendarDays = (year, month) => {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay(); 
            let days = [];
            for(let i=0; i<startDay; i++) days.push(null);
            for(let i=1; i<=daysInMonth; i++) {
                const m = String(month).padStart(2, '0');
                const dayStr = String(i).padStart(2, '0');
                days.push({ day: i, dateStr: `${year}-${m}-${dayStr}` });
            }
            return days;
        };

        // --- Components ---

        // 1. Environment Bar
        const EnvironmentBar = ({ envData, setEnvData }) => {
            const today = getTodayStr();
            const currentEnv = envData[today] || { weather: 'sunny', traffic: 'normal' };

            const updateEnv = (key, value) => {
                const newEnv = { ...envData, [today]: { ...currentEnv, [key]: value } };
                setEnvData(newEnv);
                localStorage.setItem(DB_KEY_ENV, JSON.stringify(newEnv));
            };

            const IconBtn = ({ active, onClick, icon, activeClass }) => (
                <button 
                    onClick={onClick} 
                    className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all duration-200 ${active ? activeClass + ' shadow-md ring-2 ring-white/30 scale-105' : 'bg-white/20 text-white/70 hover:bg-white/30'}`}
                >
                    <i className={icon}></i>
                </button>
            );

            return (
                <div className="sticky-env-bar">
                    <div className="flex items-center text-white">
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-2 backdrop-blur-sm">
                            <i className="fa-solid fa-fish text-sm"></i>
                        </div>
                        <div className="leading-tight">
                            <div className="font-black text-sm tracking-wider">SF.BOSS</div>
                            <div className="text-[10px] opacity-80 font-mono">v2.7</div>
                        </div>
                    </div>
                    <div className="flex space-x-3">
                        <div className="flex space-x-1 bg-black/10 p-1 rounded-xl backdrop-blur-sm">
                            <IconBtn active={currentEnv.traffic === 'slow'} onClick={() => updateEnv('traffic', 'slow')} icon="fa-solid fa-turtle" activeClass="bg-green-500 text-white" />
                            <IconBtn active={currentEnv.traffic === 'normal'} onClick={() => updateEnv('traffic', 'normal')} icon="fa-solid fa-person-walking" activeClass="bg-yellow-500 text-white" />
                            <IconBtn active={currentEnv.traffic === 'busy'} onClick={() => updateEnv('traffic', 'busy')} icon="fa-solid fa-fire" activeClass="bg-red-600 text-white" />
                        </div>
                        <div className="flex space-x-1 bg-black/10 p-1 rounded-xl backdrop-blur-sm">
                            <IconBtn active={currentEnv.weather === 'sunny'} onClick={() => updateEnv('weather', 'sunny')} icon="fa-solid fa-sun" activeClass="bg-orange-500 text-white" />
                            <IconBtn active={currentEnv.weather === 'cloudy'} onClick={() => updateEnv('weather', 'cloudy')} icon="fa-solid fa-cloud" activeClass="bg-gray-500 text-white" />
                            <IconBtn active={currentEnv.weather === 'rainy'} onClick={() => updateEnv('weather', 'rainy')} icon="fa-solid fa-cloud-showers-heavy" activeClass="bg-blue-600 text-white" />
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Timer
        const TimerButton = ({ minutes, activeTimer, startTimer, stopTimer }) => {
            const isActive = activeTimer && activeTimer.minutes === minutes;
            return (
                <button 
                    onClick={() => isActive ? stopTimer() : startTimer(minutes)}
                    className="relative h-10 bg-white rounded-lg card-shadow overflow-hidden cursor-pointer active:scale-95 transition-transform flex items-center justify-center border border-navy-50 w-full"
                >
                    {isActive && (
                        <div 
                            className="absolute left-0 top-0 bottom-0 bg-ocean-600/10 z-0 animate-progress"
                            style={{ animationDuration: `${minutes * 60}s`, width: '100%' }}
                        ></div>
                    )}
                    <span className={`relative z-10 font-bold text-xs ${isActive ? 'text-ocean-800' : 'text-gray-400'}`}>
                        {minutes}分
                    </span>
                </button>
            );
        };

        // 3. Owner Log
        const OwnerLog = ({ logs, setLogs }) => {
            const [input, setInput] = useState('');
            const addLog = () => {
                if(!input.trim()) return;
                const newLog = { id: Date.now(), date: getTodayStr(), timestamp: formatTime(), text: input };
                const updated = [newLog, ...logs];
                setLogs(updated);
                localStorage.setItem(DB_KEY_LOGS, JSON.stringify(updated));
                setInput('');
            };
            const deleteLog = (id) => {
                const updated = logs.filter(l => l.id !== id);
                setLogs(updated);
                localStorage.setItem(DB_KEY_LOGS, JSON.stringify(updated));
            };
            
            const recentLogs = logs.filter(l => (Date.now() - l.id) < (3 * 24 * 60 * 60 * 1000)).slice(0, 10);

            return (
                <div className="bg-white rounded-xl card-shadow p-4 border border-navy-50 mb-4">
                    <div className="flex justify-between items-center mb-3">
                        <h3 className="font-bold text-navy-900 text-sm flex items-center"><i className="fa-solid fa-pen-nib mr-2"></i>營運筆記</h3>
                    </div>
                    <div className="flex gap-2 mb-4">
                        <input type="text" value={input} onChange={e => setInput(e.target.value)} className="flex-1 bg-navy-50 rounded-lg px-3 py-2 text-sm focus:outline-none text-navy-900" placeholder="快速記事..." />
                        <button onClick={addLog} className="w-10 h-10 bg-navy-900 text-white rounded-lg flex items-center justify-center shrink-0 shadow-lg"><i className="fa-solid fa-plus"></i></button>
                    </div>
                    <div className="space-y-3 pl-2 border-l-2 border-navy-50 max-h-60 overflow-y-auto no-scrollbar">
                        {recentLogs.length === 0 ? <p className="text-xs text-gray-300 py-1 pl-2">今日尚未記錄</p> : 
                            recentLogs.map(l => (
                                <div key={l.id} className="relative pl-4 animate-fade-in group">
                                    <div className="absolute left-[-13px] top-1.5 w-2 h-2 rounded-full bg-navy-200"></div>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <span className="text-[10px] font-bold text-navy-500 mr-2">{l.date === getTodayStr() ? l.timestamp : l.date}</span>
                                            <p className="text-sm text-darkgray break-all inline">{l.text}</p>
                                        </div>
                                        <button onClick={() => deleteLog(l.id)} className="text-gray-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100 transition-opacity"><i className="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            );
        };

        // --- Pages ---

        // A. Owner Dashboard
        const Dashboard = ({ setPage, transactions, logs, setLogs, activeTimer, startTimer, stopTimer, settings }) => {
            const today = getTodayStr();
            const todayStats = useMemo(() => {
                const todayTrans = transactions.filter(t => t.date === today);
                const income = todayTrans.filter(t => t.type === 'income').reduce((acc, c) => acc + c.amount, 0);
                const expense = todayTrans.filter(t => t.type === 'expense').reduce((acc, c) => acc + c.amount, 0);
                const net = income - expense - (settings.dailyFixedCost || 0);
                let status = "觀察中"; let color = "bg-gray-400";
                if (net > 1000) { status = "營收穩健"; color = "bg-green-500"; }
                else if (net >= -1000) { status = "收支平衡"; color = "bg-yellow-500"; }
                else { status = "審慎留意"; color = "bg-red-500"; }
                return { net, status, color };
            }, [transactions, settings, today]);

            return (
                <div className="min-h-screen relative">
                    <div className="sticky-sub-header px-4 z-50 bg-[#F8FAFC]">
                        <div onClick={() => setPage('ai')} className="bg-white rounded-full p-2 pl-4 pr-2 flex items-center justify-between cursor-pointer border border-navy-50 shadow-sm active:scale-95 transition-transform">
                            <div className="flex items-center space-x-3">
                                <div className="w-8 h-8 bg-ocean-600 rounded-full flex items-center justify-center text-white"><i className="fa-solid fa-robot text-xs"></i></div>
                                <span className="text-gray-400 text-xs font-medium">問問 AI 參謀...</span>
                            </div>
                            <div className="flex space-x-1">
                                <div className="w-8 h-8 bg-navy-50 rounded-full flex items-center justify-center text-navy-600"><i className="fa-solid fa-microphone text-xs"></i></div>
                                <div className="w-8 h-8 bg-navy-50 rounded-full flex items-center justify-center text-navy-600"><i className="fa-solid fa-camera text-xs"></i></div>
                            </div>
                        </div>
                    </div>

                    <div className="px-4 pb-20 pt-2 animate-fade-in flex flex-col h-full">
                        <OwnerLog logs={logs} setLogs={setLogs} />

                        <div className="mb-6">
                            <p className="text-[10px] text-gray-400 font-bold mb-2 ml-1 tracking-wider uppercase">Transition Timer</p>
                            <div className="grid grid-cols-3 gap-2">
                                <TimerButton minutes={10} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />
                                <TimerButton minutes={15} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />
                                <TimerButton minutes={20} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />
                            </div>
                        </div>

                        <div className="mt-auto">
                            <p className="text-[10px] text-gray-400 font-bold mb-2 ml-1 tracking-wider uppercase">Financials (Private)</p>
                            <div onClick={() => setPage('ops')} className="bg-gradient-to-br from-white to-gray-50 rounded-xl card-shadow p-5 border border-navy-50 flex items-center justify-between active:scale-95 transition-transform cursor-pointer">
                                <div className="flex items-center">
                                    <div className="w-10 h-10 bg-navy-900 rounded-lg flex items-center justify-center text-white mr-3 shadow-md">
                                        <i className="fa-solid fa-calculator text-sm"></i>
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-navy-900 text-sm">內部營運</h3>
                                        <p className="text-[10px] text-gray-400">點擊查看詳情</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <span className={`text-xl font-black ${todayStats.net >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                        {todayStats.net > 0 ? '+' : ''}{todayStats.net.toLocaleString()}
                                    </span>
                                    <p className="text-[10px] text-gray-400">今日淨利(估)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="fixed bottom-[60px] left-0 right-0 bg-white border-t border-navy-50 p-2 flex items-center justify-between px-4 z-40">
                        <span className="text-xs font-bold text-gray-500">今日狀態</span>
                        <div className="flex items-center space-x-2">
                            <span className="text-xs font-bold text-navy-900">{todayStats.status}</span>
                            <div className={`h-2 w-16 rounded-full ${todayStats.color}`}></div>
                        </div>
                    </div>
                </div>
            );
        };

        // B. Operations
        const Operations = ({ transactions, setTransactions, settings, saveSettings }) => {
            const [period, setPeriod] = useState('day'); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSettingModal, setShowSettingModal] = useState(false);
            const [isCalExpanded, setIsCalExpanded] = useState(true); 
            
            const [selectedDate, setSelectedDate] = useState(getTodayStr());
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
            
            const [date, setDate] = useState(getTodayStr());
            const [type, setType] = useState('income');
            const [amount, setAmount] = useState('');
            const [cat, setCat] = useState('現金');
            const [note, setNote] = useState('');
            const [tempFixedCost, setTempFixedCost] = useState(settings.dailyFixedCost);

            const stats = useMemo(() => {
                const now = new Date();
                const yearStr = now.getFullYear().toString();
                const monthStr = `${yearStr}-${String(currentMonth).padStart(2, '0')}`;
                let filtered = [], fixedCostTotal = 0, listData = [], net = 0, income = 0, expense = 0;
                const dailyStats = {}; 

                transactions.forEach(t => {
                    if(!dailyStats[t.date]) dailyStats[t.date] = { income: 0, expense: 0 };
                    if(t.type === 'income') dailyStats[t.date].income += t.amount;
                    else dailyStats[t.date].expense += t.amount;
                });

                if (period === 'day') {
                    filtered = transactions.filter(t => t.date === selectedDate);
                    fixedCostTotal = parseInt(settings.dailyFixedCost || 0);
                    listData = filtered;
                    income = filtered.filter(t => t.type === 'income').reduce((a,c) => a+c.amount, 0);
                    expense = filtered.filter(t => t.type === 'expense').reduce((a,c) => a+c.amount, 0);
                } else if (period === 'month') {
                    filtered = transactions.filter(t => t.date.startsWith(monthStr));
                    const daysInM = new Date(now.getFullYear(), currentMonth, 0).getDate();
                    let daysPassed = daysInM;
                    if(now.getFullYear() === parseInt(yearStr) && (now.getMonth() + 1) === currentMonth) {
                        daysPassed = now.getDate();
                    }
                    fixedCostTotal = parseInt(settings.dailyFixedCost || 0) * daysPassed;
                    income = filtered.filter(t => t.type === 'income').reduce((a,c) => a+c.amount, 0);
                    expense = filtered.filter(t => t.type === 'expense').reduce((a,c) => a+c.amount, 0);
                    listData = transactions.filter(t => t.date === selectedDate);
                } else { // Year
                    filtered = transactions.filter(t => t.date.startsWith(yearStr));
                    const startOfYear = new Date(now.getFullYear(), 0, 1);
                    const diffTime = Math.abs(now - startOfYear);
                    const daysPassedYear = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    fixedCostTotal = parseInt(settings.dailyFixedCost || 0) * daysPassedYear;

                    income = filtered.filter(t => t.type === 'income').reduce((a,c) => a+c.amount, 0);
                    expense = filtered.filter(t => t.type === 'expense').reduce((a,c) => a+c.amount, 0);
                    const grouped = {};
                    filtered.forEach(t => {
                         const m = t.date.slice(0, 7);
                         if(!grouped[m]) grouped[m] = { date: m, income: 0, expense: 0 };
                         if(t.type === 'income') grouped[m].income += t.amount;
                         else grouped[m].expense += t.amount;
                    });
                    listData = Object.values(grouped).sort((a,b) => b.date.localeCompare(a.date));
                }
                net = income - expense - fixedCostTotal;
                return { income, expense, fixedCostTotal, net, listData, dailyStats };
            }, [transactions, settings, period, selectedDate, currentMonth]);

            const handleSave = () => {
                if (!amount) return;
                const newTrans = { id: Date.now(), date: date, amount: parseInt(amount), type, category: cat, note, timestamp: formatTime() };
                const updated = [newTrans, ...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                setTransactions(updated);
                localStorage.setItem(DB_KEY_TRANSACTIONS, JSON.stringify(updated));
                setAmount(''); setNote(''); setShowAddModal(false);
            };

            const calendarDays = useMemo(() => getCalendarDays(new Date().getFullYear(), currentMonth), [currentMonth]);

            return (
                <div className="pb-20 animate-fade-in min-h-screen">
                    <div className="sticky-sub-header bg-white px-4 border-b border-navy-50 flex justify-between items-center shadow-sm">
                        <h2 className="font-black text-navy-900 text-lg">營運報表</h2>
                        <button onClick={() => setShowSettingModal(true)} className="w-8 h-8 rounded-full bg-navy-50 text-navy-600 flex items-center justify-center"><i className="fa-solid fa-gear"></i></button>
                    </div>
                    <div className="sticky top-[108px] z-30 bg-gray-50 px-4 py-2 border-b border-gray-100 shadow-sm flex justify-between items-center">
                        <div className="bg-white p-0.5 rounded-lg border border-navy-50 shadow-sm inline-flex">
                            {['day', 'month', 'year'].map(p => (
                                <button key={p} onClick={() => setPeriod(p)} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${period === p ? 'bg-navy-900 text-white shadow' : 'text-gray-500'}`}>
                                    {p === 'day' ? '日' : p === 'month' ? '月' : '年'}
                                </button>
                            ))}
                        </div>
                        {period === 'day' && <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="bg-white border border-navy-50 text-navy-900 text-xs font-bold py-1 px-2 rounded-md focus:outline-none" />}
                        {period === 'month' && (
                            <div className="flex items-center space-x-2 bg-white px-2 py-1 rounded-md border border-navy-50">
                                <button onClick={() => setCurrentMonth(p => p===1?12:p-1)} className="text-navy-600"><i className="fa-solid fa-chevron-left text-xs"></i></button>
                                <span className="text-xs font-bold text-navy-900 w-8 text-center">{currentMonth}月</span>
                                <button onClick={() => setCurrentMonth(p => p===12?1:p+1)} className="text-navy-600"><i className="fa-solid fa-chevron-right text-xs"></i></button>
                            </div>
                        )}
                    </div>

                    <div className="px-4 pt-4">
                        <div className="bg-white rounded-xl p-5 mb-6 card-shadow border-l-4 border-navy-900 relative overflow-hidden">
                            <div className="absolute right-0 top-0 p-3 opacity-5"><i className="fa-solid fa-chart-line text-6xl"></i></div>
                            <div className="flex justify-between items-center mb-2"><span className="text-gray-500 font-bold text-xs">營收總額</span><span className="text-lg font-bold text-navy-900">+ {stats.income.toLocaleString()}</span></div>
                            <div className="flex justify-between items-center mb-2"><span className="text-gray-500 font-bold text-xs">臨時支出</span><span className="text-lg font-bold text-red-500">- {stats.expense.toLocaleString()}</span></div>
                            <div className="flex justify-between items-center mb-3 pb-3 border-b border-dashed border-gray-200"><span className="text-gray-400 font-bold text-[10px]">固定攤提 (動態)</span><span className="text-sm font-bold text-gray-400">- {stats.fixedCostTotal.toLocaleString()}</span></div>
                            <div className="flex justify-between items-end"><span className="text-navy-900 font-black text-sm">淨利結餘</span><span className={`text-2xl font-black ${stats.net >= 0 ? 'text-green-600' : 'text-red-600'}`}>{stats.net > 0 ? '+' : ''}{stats.net.toLocaleString()}</span></div>
                        </div>

                        {period === 'month' && (
                            <div className="mb-6 bg-white rounded-xl p-4 card-shadow">
                                <div className="flex justify-between items-center mb-2 cursor-pointer" onClick={() => setIsCalExpanded(!isCalExpanded)}>
                                    <span className="text-xs font-bold text-gray-400">日曆視圖</span>
                                    <i className={`fa-solid fa-chevron-${isCalExpanded ? 'up' : 'down'} text-gray-400 text-xs`}></i>
                                </div>
                                {isCalExpanded && (
                                    <div className="animate-fade-in">
                                        <div className="grid grid-cols-7 gap-1 mb-2 text-center">{['日','一','二','三','四','五','六'].map(d => <span key={d} className="text-[10px] text-gray-400 font-bold">{d}</span>)}</div>
                                        <div className="grid grid-cols-7 gap-1">
                                            {calendarDays.map((d, i) => {
                                                if(!d) return <div key={i}></div>;
                                                const s = stats.dailyStats[d.dateStr];
                                                const net = s ? (s.income - s.expense - (settings.dailyFixedCost||0)) : -(settings.dailyFixedCost||0);
                                                const hasData = s && (s.income > 0 || s.expense > 0);
                                                const isSelected = selectedDate === d.dateStr;
                                                return (
                                                    <div key={i} onClick={() => setSelectedDate(d.dateStr)} className={`aspect-square flex flex-col items-center justify-center rounded-lg cursor-pointer border transition-colors ${isSelected ? 'bg-navy-900 border-navy-900' : 'border-transparent hover:bg-gray-50'}`}>
                                                        <span className={`text-xs font-bold ${isSelected ? 'text-white' : 'text-gray-500'}`}>{d.day}</span>
                                                        <div className={`w-1.5 h-1.5 rounded-full mt-1 ${net > 0 ? 'bg-green-500' : 'bg-red-500'} ${!hasData ? 'opacity-0' : ''}`}></div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <button onClick={() => {setType('income'); setCat('現金'); setDate(selectedDate); setShowAddModal(true);}} className="bg-navy-900 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center text-base active:scale-95 transition-transform"><i className="fa-solid fa-plus mr-2"></i> 記進帳</button>
                            <button onClick={() => {setType('expense'); setCat('進貨'); setDate(selectedDate); setShowAddModal(true);}} className="bg-white text-darkgray border border-gray-200 py-4 rounded-xl font-bold shadow flex items-center justify-center text-base active:scale-95 transition-transform"><i className="fa-solid fa-minus mr-2"></i> 記出帳</button>
                        </div>

                        <h3 className="font-bold text-gray-800 mb-3 text-xs border-l-4 border-navy-500 pl-2">
                            {period === 'day' ? `流水帳 (${selectedDate})` : period === 'month' ? `明細 (${selectedDate})` : '月度匯總'}
                        </h3>
                        <div className="space-y-3">
                            {stats.listData.length === 0 ? <p className="text-gray-400 text-center py-8 text-xs">尚無資料</p> : 
                                stats.listData.map((item, idx) => (
                                    <div key={idx} className="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm border-l-2 border-navy-50">
                                        {period === 'year' ? (
                                            <><div className="flex flex-col"><span className="font-bold text-gray-800 text-sm">{item.date}</span></div><span className={`font-bold text-sm ${(item.income - item.expense) >= 0 ? 'text-green-600' : 'text-red-600'}`}>{(item.income - item.expense).toLocaleString()}</span></>
                                        ) : (
                                            <>
                                                <div className="flex items-center">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 ${item.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                        <i className={`fa-solid ${item.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'} text-xs`}></i>
                                                    </div>
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="font-bold text-darkgray text-sm">{item.category}</span>
                                                            <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">{item.timestamp?.slice(0,5)}</span>
                                                        </div>
                                                        <p className="text-xs text-gray-400">{item.note}</p>
                                                    </div>
                                                </div>
                                                <span className={`font-bold text-base ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>{item.type === 'income' ? '+' : '-'}{item.amount.toLocaleString()}</span>
                                            </>
                                        )}
                                    </div>
                                ))
                            }
                        </div>
                    </div>

                    {showAddModal && (
                        <div className="fixed inset-0 bg-navy-900 bg-opacity-40 z-[70] flex items-end sm:items-center justify-center sm:p-4">
                            <div className="bg-white rounded-t-2xl sm:rounded-xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
                                <h3 className="font-black text-xl mb-6 text-navy-900">記一筆{type === 'income' ? '進帳' : '出帳'}</h3>
                                <div className="space-y-5">
                                    <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full bg-navy-50 p-3 rounded-lg font-bold text-navy-800" />
                                    <div className="relative">
                                        <span className="absolute left-0 top-2 text-2xl font-bold text-navy-900">$</span>
                                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full pl-6 text-4xl font-black border-b-2 border-navy-900 py-2 focus:outline-none text-navy-900 placeholder-gray-200" placeholder="0" autoFocus />
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {type === 'income' 
                                            ? ['現金', '刷卡', '外送平台', '其他'].map(c => <button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-full text-xs font-bold border transition-colors ${cat === c ? 'bg-navy-900 text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>{c}</button>) 
                                            : ['進貨', '人事', '雜支', '修繕', '房租'].map(c => <button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-full text-xs font-bold border transition-colors ${cat === c ? 'bg-navy-900 text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>{c}</button>)}
                                    </div>
                                    <input type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full bg-gray-50 rounded-lg p-3 text-sm focus:outline-none" placeholder="備註 (選填)..." />
                                    <div className="flex gap-3 mt-4">
                                        <button onClick={() => setShowAddModal(false)} className="flex-1 py-4 text-gray-500 font-bold bg-gray-100 rounded-xl">取消</button>
                                        <button onClick={handleSave} className="flex-1 py-4 bg-navy-900 text-white rounded-xl font-bold shadow-lg">確認</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {showSettingModal && (
                        <div className="fixed inset-0 bg-navy-900 bg-opacity-40 z-[70] flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
                                <h3 className="font-bold text-lg mb-4 text-navy-900">日均營運成本</h3>
                                <input type="number" value={tempFixedCost} onChange={e => setTempFixedCost(e.target.value)} className="w-full text-3xl font-black border-b-2 border-navy-900 py-2 mb-6 focus:outline-none text-navy-900" />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSettingModal(false)} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-lg">取消</button>
                                    <button onClick={() => { saveSettings({...settings, dailyFixedCost: parseInt(tempFixedCost)}); setShowSettingModal(false); }} className="flex-1 py-3 bg-navy-900 text-white rounded-lg font-bold">儲存</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // C. AI Advisor (v2.7 Stable Model Fix)
        const AIAdvisor = ({ settings, saveSettings, transactions, envData, logs }) => {
             const [input, setInput] = useState('');
             const [chat, setChat] = useState([{ id: 1, role: 'ai', text: '老闆好，我是 v2.7 AI 參謀 (Gemini Pro)。我們切換到最穩定的頻道了。' }]);
             const [showSettings, setShowSettings] = useState(false);
             const [apiKey, setApiKey] = useState(settings.apiKey || '');
             const [isTyping, setIsTyping] = useState(false);
             const messagesEndRef = useRef(null);

             const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };
             useEffect(scrollToBottom, [chat]);

             const handleSaveSettings = () => {
                 const cleanKey = apiKey.trim(); 
                 setApiKey(cleanKey); 
                 saveSettings({...settings, apiKey: cleanKey}); 
                 setShowSettings(false);
             };

             const getContextData = () => {
                 const today = getTodayStr();
                 const todayTrans = transactions.filter(t => t.date === today);
                 const income = todayTrans.filter(t => t.type === 'income').reduce((acc, c) => acc + c.amount, 0);
                 const expense = todayTrans.filter(t => t.type === 'expense').reduce((acc, c) => acc + c.amount, 0);
                 const net = income - expense - (settings.dailyFixedCost || 0);
                 
                 const env = envData[today] || { weather: '未記錄', traffic: '未記錄' };
                 const recentLogs = logs.slice(0, 3).map(l => `[${l.timestamp}] ${l.text}`).join('; ');

                 return `
                    環境數據：日期=${today}, 天氣=${env.weather}, 客流=${env.traffic}
                    財務數據：今日營收=${income}, 今日支出=${expense}, 今日淨利(扣除成本)=${net}
                    最近筆記：${recentLogs || '無'}
                 `;
             };

             const handleSend = async () => {
                 if(!input.trim()) return;
                 if(isTyping) return;

                 const userMsg = input;
                 setChat(prev => [...prev, { id: Date.now(), role: 'user', text: userMsg }]);
                 setInput('');
                 setIsTyping(true);

                 const currentKey = settings.apiKey ? settings.apiKey.trim() : '';

                 if (!currentKey) {
                     setTimeout(() => {
                         setChat(prev => [...prev, { id: Date.now()+1, role: 'ai', text: "請先設定 API Key (鑰匙圖示)。" }]);
                         setIsTyping(false);
                     }, 500);
                     return;
                 }

                 const context = getContextData();
                 const systemPrompt = `你是一位餐飲經營顧問，語氣簡潔、專業、像個老大哥。
                 以下是目前店內的即時數據：
                 ${context}
                 
                 請根據以上數據回答老闆的問題：${userMsg}`;

                 try {
                     // *** v2.7 FIX: Use 'gemini-pro' (The Universal 1.0 Model) ***
                     // This model is the "old faithful" that works with almost all Free Tier keys
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${currentKey}`, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             contents: [{ parts: [{ text: systemPrompt }] }]
                         })
                     });

                     if (!response.ok) {
                         const errData = await response.json();
                         throw new Error(errData.error?.message || `HTTP Error ${response.status}`);
                     }
                     const data = await response.json();
                     const aiText = data.candidates[0].content.parts[0].text;

                     setChat(prev => [...prev, { id: Date.now()+1, role: 'ai', text: aiText }]);
                 } catch (error) {
                     setChat(prev => [...prev, { id: Date.now()+1, role: 'ai', text: `連線錯誤: ${error.message}` }]);
                 } finally {
                     setIsTyping(false);
                 }
             };

             return (
                <div className="pt-4 pb-20 px-4 h-full flex flex-col min-h-screen">
                    <div className="flex justify-between items-center mb-4 sticky top-[60px] bg-gray-50 z-20 py-2">
                        <div className="flex items-center">
                            <div className="w-10 h-10 bg-navy-900 rounded-full flex items-center justify-center text-white mr-3 shadow">
                                <i className="fa-solid fa-robot text-sm"></i>
                            </div>
                            <div>
                                <h1 className="font-bold text-navy-900">AI 參謀</h1>
                                <span className="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full animate-pulse">Live (Gemini Pro)</span>
                            </div>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="text-navy-600 bg-white p-2 rounded-full border border-navy-100 shadow-sm"><i className="fa-solid fa-key"></i></button>
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-4 mb-4 pr-1">
                        {chat.map(c => (
                            <div key={c.id} className={`flex ${c.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl shadow-sm text-sm ${c.role === 'user' ? 'bg-navy-900 text-white rounded-br-none' : 'bg-white text-darkgray border border-navy-50 rounded-bl-none'}`}>
                                    {c.text}
                                </div>
                            </div>
                        ))}
                        {isTyping && (
                            <div className="flex justify-start">
                                <div className="bg-white text-gray-400 p-3 rounded-2xl rounded-bl-none shadow-sm text-xs flex items-center">
                                    <i className="fa-solid fa-circle-notch fa-spin mr-2"></i> 思考中...
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="fixed bottom-[60px] left-0 right-0 p-3 bg-white border-t border-navy-50 flex gap-2 z-40 items-center">
                        <button className="w-10 h-10 rounded-full bg-navy-50 text-navy-600 flex items-center justify-center"><i className="fa-solid fa-microphone"></i></button>
                        <button className="w-10 h-10 rounded-full bg-navy-50 text-navy-600 flex items-center justify-center"><i className="fa-solid fa-camera"></i></button>
                        <input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} className="flex-1 bg-navy-50 rounded-full px-4 py-3 text-sm text-darkgray focus:outline-none" placeholder="輸入..." disabled={isTyping} />
                        <button onClick={handleSend} className={`w-11 h-11 rounded-full text-white flex items-center justify-center shadow-lg transition-transform ${isTyping ? 'bg-gray-400' : 'bg-navy-900 active:scale-95'}`} disabled={isTyping}><i className="fa-solid fa-paper-plane text-xs"></i></button>
                    </div>
                    {showSettings && (
                        <div className="fixed inset-0 bg-navy-900 bg-opacity-50 z-[80] flex items-center justify-center p-6">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
                                <h3 className="font-bold text-navy-900 mb-2">設定 AI 大腦</h3>
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-navy-50 border border-navy-100 rounded-lg p-3 text-sm mb-6 focus:outline-none" placeholder="Paste Gemini API Key Here..." />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSettings(false)} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-lg">取消</button>
                                    <button onClick={handleSaveSettings} className="flex-1 py-3 bg-navy-900 text-white rounded-lg font-bold">儲存</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
             );
        };

        // --- Main App ---
        const App = () => {
            const [page, setPage] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [logs, setLogs] = useState([]);
            const [settings, setSettings] = useState({ dailyFixedCost: 5000, apiKey: '' });
            const [envData, setEnvData] = useState({});
            const [activeTimer, setActiveTimer] = useState(null);
            
            useEffect(() => {
                const t = localStorage.getItem(DB_KEY_TRANSACTIONS); if(t) setTransactions(JSON.parse(t));
                const l = localStorage.getItem(DB_KEY_LOGS); if(l) setLogs(JSON.parse(l));
                const s = localStorage.getItem(DB_KEY_SETTINGS); if(s) setSettings(JSON.parse(s));
                const e = localStorage.getItem(DB_KEY_ENV); if(e) setEnvData(JSON.parse(e));
            }, []);

            const saveSettings = (newSettings) => {
                setSettings(newSettings);
                localStorage.setItem(DB_KEY_SETTINGS, JSON.stringify(newSettings));
            };

            const startTimer = (m) => { setActiveTimer({ minutes: m, startTime: Date.now() }); };
            const stopTimer = () => { setActiveTimer(null); };
            useEffect(() => {
                let interval;
                if (activeTimer) {
                    interval = setInterval(() => {
                        const elapsed = (Date.now() - activeTimer.startTime) / 1000;
                        if (elapsed >= activeTimer.minutes * 60) {
                            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                            alert('轉場時間到！'); setActiveTimer(null);
                        }
                    }, 1000);
                } return () => clearInterval(interval);
            }, [activeTimer]);

            return (
                <div className="bg-white max-w-md mx-auto relative shadow-2xl min-h-screen pb-[60px]">
                    <EnvironmentBar envData={envData} setEnvData={setEnvData} />
                    <div className="content-padding min-h-screen bg-gray-50"> 
                        {page === 'dashboard' && <Dashboard setPage={setPage} transactions={transactions} logs={logs} setLogs={setLogs} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} settings={settings} />}
                        {page === 'ops' && <Operations transactions={transactions} setTransactions={setTransactions} settings={settings} saveSettings={saveSettings} />}
                        {page === 'ai' && <AIAdvisor settings={settings} saveSettings={saveSettings} transactions={transactions} envData={envData} logs={logs} />}
                    </div>
                    <div className="bottom-nav-fix flex justify-around items-center h-[60px] border-t border-navy-50">
                        <button onClick={() => setPage('dashboard')} className={`flex flex-col items-center w-full py-2 transition-colors ${page === 'dashboard' ? 'text-navy-900' : 'text-gray-300'}`}>
                            <i className="fa-solid fa-chart-pie text-lg mb-0.5"></i>
                            <span className="text-[10px] font-bold">總覽</span>
                        </button>
                        <button onClick={() => setPage('ops')} className={`flex flex-col items-center w-full py-2 transition-colors ${page === 'ops' ? 'text-navy-900' : 'text-gray-300'}`}>
                            <i className="fa-solid fa-calculator text-lg mb-0.5"></i>
                            <span className="text-[10px] font-bold">營運</span>
                        </button>
                        <button onClick={() => setPage('ai')} className={`flex flex-col items-center w-full py-2 transition-colors ${page === 'ai' ? 'text-navy-900' : 'text-gray-300'}`}>
                            <i className="fa-solid fa-robot text-lg mb-0.5"></i>
                            <span className="text-[10px] font-bold">AI</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // --- SW Registration (sw-v2.7.js) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw-v2.7.js').then(registration => {
                    registration.onupdatefound = () => {
                        const installingWorker = registration.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    window.location.reload();
                                }
                            }
                        };
                    };
                });
            });
        }
    </script>
</body>
</html>