<!-- Ê™îÂêçÔºöSeafoodBossApp_v4.8_Final.html -->
<!-- ÁâàÊú¨Ôºöv4.8 (Connection Fix Edition) -->
<!-- Ê†∏ÂøÉÔºö‰øÆÂæ© fetch ÈÇèËºØÔºåÂ¢ûÂä† CORS Á©©ÂÆöÊÄßËàáÈåØË™§ÂõûÂ†±„ÄÇUI Á∂≠ÊåÅ v4.7 ‰∏çËÆä„ÄÇ -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SEAFOOD.BOSS (v4.8)</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0284c7"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: {
                            50: '#F0F9FF',
                            100: '#E0F2FE',
                            500: '#0EA5E9',
                            800: '#075985',
                            900: '#0C4A6E',
                        },
                        finance: {
                            light: '#E0F2FE',
                            main: '#0369A1', 
                            dark: '#0C4A6E', 
                        },
                        ai: {
                            light: '#F5F3FF', 
                            main: '#8B5CF6', 
                            dark: '#5B21B6', 
                        },
                        note: {
                            bg: '#FFFBEB', 
                            border: '#FCD34D', 
                            text: '#92400E', 
                        },
                        alert: {
                            main: '#EA580C', 
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #F8FAFC;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
            color: #334155;
            overflow: hidden; 
        }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes shrinkWidth { from { width: 100%; } to { width: 0%; } }
        .animate-progress { animation-name: shrinkWidth; animation-timing-function: linear; animation-fill-mode: forwards; }
        
        .dashboard-container {
            height: 100vh;
            position: relative;
            background-color: #F8FAFC;
            overflow: hidden;
        }

        .scrollable-page {
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px; 
            padding-top: 60px; 
        }

        .sticky-header-main {
            position: fixed; top: 0; left: 0; right: 0; z-index: 60;
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sticky-top-area {
            position: fixed; top: 60px; left: 0; right: 0; z-index: 55;
            background-color: #F8FAFC; padding: 0.5rem 1rem;
            max-width: 28rem; margin: 0 auto;
        }

        .force-bottom-container {
            position: fixed; bottom: 90px; 
            left: 0; right: 0; z-index: 30;
            padding: 0 1rem; max-width: 28rem; margin: 0 auto;
            background: linear-gradient(to top, #F8FAFC 95%, transparent);
            padding-top: 20px;
        }

        .status-bar-fixed {
            position: fixed; bottom: 60px; left: 0; right: 0; z-index: 40;
            height: 30px;
            background-color: #1E293B;
            border-top: 1px solid #374151;
            max-width: 28rem; margin: 0 auto;
        }
        
        .sticky-ops-controls {
            position: sticky; top: 0; z-index: 50;
            background-color: #F8FAFC; 
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
            padding-top: 16px;
        }

        .header-gradient { background: linear-gradient(to right, #0284c7, #0369a1); }
        .modal-overlay { z-index: 200; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // DB Keys
        const DB_KEY_TRANSACTIONS = 'sf_transactions'; 
        const DB_KEY_LOGS = 'sf_logs';                 
        const DB_KEY_SETTINGS = 'sf_settings';         
        const DB_KEY_ENV = 'sf_daily_env';             
        const DB_KEY_CHAT = 'sf_ai_chat';

        // --- Helpers ---
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        const formatTime = () => new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute:'2-digit' });
        
        const getCalendarDays = (year, month) => {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay(); 
            let days = [];
            for(let i=0; i<startDay; i++) days.push(null);
            for(let i=1; i<=daysInMonth; i++) {
                const m = String(month).padStart(2, '0');
                const dayStr = String(i).padStart(2, '0');
                days.push({ day: i, dateStr: `${year}-${m}-${dayStr}` });
            }
            return days;
        };

        const useVoiceInput = (onResult) => {
            const [isListening, setIsListening] = useState(false);
            const startListening = () => {
                if (!('webkitSpeechRecognition' in window)) { alert("‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•"); return; }
                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'zh-TW'; recognition.continuous = false; recognition.interimResults = false;
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => { onResult(event.results[0][0].transcript); };
                recognition.start();
            };
            return { isListening, startListening };
        };

        const useTTS = () => {
            const speak = (text) => {
                if (!('speechSynthesis' in window)) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW'; utterance.rate = 1.0; 
                window.speechSynthesis.cancel(); window.speechSynthesis.speak(utterance);
            };
            return { speak };
        };

        // --- Components ---

        const MainHeader = ({ title = "SEAFOOD.BOSS", showKey = false, onKeyClick, themeClass = "header-gradient" }) => (
            <div className={`sticky-header-main ${themeClass}`}>
                <div className="flex items-center text-white">
                    <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-2 backdrop-blur-sm">
                        <i className="fa-solid fa-fish text-sm"></i>
                    </div>
                    <div className="leading-tight">
                        <div className="font-black text-sm tracking-wider uppercase">{title}</div>
                        <div className="text-[10px] opacity-80 font-mono">v4.8</div>
                    </div>
                </div>
                {showKey && (
                    <button onClick={onKeyClick} className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-white hover:bg-white/30 transition-colors">
                        <i className="fa-solid fa-gear text-xs"></i>
                    </button>
                )}
            </div>
        );

        const TimerButton = ({ minutes, activeTimer, startTimer, stopTimer }) => {
            const isActive = activeTimer && activeTimer.minutes === minutes;
            return (
                <button 
                    onClick={() => isActive ? stopTimer() : startTimer(minutes)}
                    className={`relative h-12 rounded-xl overflow-hidden cursor-pointer active:scale-95 transition-all flex items-center justify-center w-full shadow-sm border ${isActive ? 'bg-alert-main border-alert-main animate-pulse-slow' : 'bg-white border-slate-200'}`}
                >
                    {isActive && <div className="absolute left-0 top-0 bottom-0 bg-white/20 z-0 animate-progress" style={{ animationDuration: `${minutes * 60}s`, width: '100%' }}></div>}
                    <span className={`relative z-10 font-black text-lg ${isActive ? 'text-white' : 'text-gray-400'}`}>{minutes}</span>
                </button>
            );
        };

        const OwnerLog = ({ logs, setLogs }) => {
            const [input, setInput] = useState('');
            const [isPrivacy, setIsPrivacy] = useState(false);
            const { isListening, startListening } = useVoiceInput((text) => setInput(prev => prev + text));

            const addLog = () => {
                if(!input.trim()) return;
                const newLog = { id: Date.now(), date: getTodayStr(), timestamp: formatTime(), text: input };
                const updated = [newLog, ...logs];
                setLogs(updated);
                localStorage.setItem(DB_KEY_LOGS, JSON.stringify(updated));
                setInput('');
            };
            const deleteLog = (id) => {
                const updated = logs.filter(l => l.id !== id);
                setLogs(updated);
                localStorage.setItem(DB_KEY_LOGS, JSON.stringify(updated));
            };
            const recentLogs = logs.filter(l => (Date.now() - l.id) < (3 * 24 * 60 * 60 * 1000)).slice(0, 10);

            return (
                <div className="bg-note-bg border-b-4 border-note-border/30 rounded-xl p-3 mb-2 shadow-sm">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="font-bold text-note-text text-xs flex items-center gap-2">
                            <i className="fa-solid fa-note-sticky"></i> ÁáüÈÅãÁ≠ÜË®ò
                        </h3>
                        <button onClick={() => setIsPrivacy(!isPrivacy)} className="text-note-text opacity-60 hover:opacity-100 transition-opacity">
                            <i className={`fa-solid ${isPrivacy ? 'fa-eye-slash' : 'fa-eye'} text-xs`}></i>
                        </button>
                    </div>
                    <div className="flex gap-2 mb-3">
                        <input type="text" value={input} onChange={e => setInput(e.target.value)} className="flex-1 bg-white rounded-lg px-3 py-2 text-sm focus:outline-none text-slate-700 border border-note-border/30" placeholder="Ë®ò‰∫ã..." />
                        <button onClick={startListening} className={`w-9 h-9 rounded-lg flex items-center justify-center shrink-0 transition-colors ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-white text-gray-400 border border-gray-200'}`}><i className="fa-solid fa-microphone"></i></button>
                        <button onClick={addLog} className="w-9 h-9 bg-note-text text-white rounded-lg flex items-center justify-center shrink-0 shadow-sm"><i className="fa-solid fa-plus"></i></button>
                    </div>
                    <div className="space-y-2 pl-1 max-h-[150px] overflow-y-auto no-scrollbar">
                        {recentLogs.length === 0 ? <p className="text-[10px] text-gray-400 py-1">Â∞öÁÑ°Á¥ÄÈåÑ</p> : 
                            recentLogs.map(l => (
                                <div key={l.id} className="relative pl-2 animate-fade-in group flex justify-between items-start">
                                    <div className={`text-sm text-slate-700 leading-tight w-full ${isPrivacy ? 'blur-sm select-none opacity-50' : ''}`}>
                                        <span className="text-[10px] font-bold text-note-text/60 mr-1.5">{l.date === getTodayStr() ? l.timestamp : l.date}</span>
                                        {isPrivacy ? '******' : l.text}
                                    </div>
                                    <button onClick={() => deleteLog(l.id)} className="text-gray-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100"><i className="fa-solid fa-xmark text-xs"></i></button>
                                </div>
                            ))
                        }
                    </div>
                </div>
            );
        };

        // --- Pages ---

        // A. Dashboard
        const Dashboard = ({ setPage, transactions, logs, setLogs, activeTimer, startTimer, stopTimer, settings }) => {
            const today = getTodayStr();
            const todayStats = useMemo(() => {
                const todayTrans = transactions.filter(t => t.date === today);
                const income = todayTrans.filter(t => t.type === 'income').reduce((acc, c) => acc + c.amount, 0);
                const expense = todayTrans.filter(t => t.type === 'expense').reduce((acc, c) => acc + c.amount, 0);
                const net = income - expense - (settings.dailyFixedCost || 0);
                let status = "ËßÄÂØü‰∏≠"; let color = "bg-gray-500";
                if (net > 1000) { status = "ÁáüÊî∂Á©©ÂÅ•"; color = "bg-green-500"; }
                else if (net >= 0) { status = "Êî∂ÊîØÂπ≥Ë°°"; color = "bg-yellow-500"; }
                else { status = "ÂØ©ÊÖéÁïôÊÑè"; color = "bg-red-500"; }
                return { net, status, color };
            }, [transactions, settings, today]);

            return (
                <div className="dashboard-container">
                    <MainHeader />
                    <div className="sticky-top-area">
                        <div onClick={() => setPage('ai')} className="bg-white rounded-xl p-2 pl-4 pr-2 flex items-center justify-between cursor-pointer border-l-4 border-ai-main shadow-sm active:scale-95 transition-transform mb-3">
                            <div className="flex items-center space-x-3">
                                <div className="w-8 h-8 bg-ai-main rounded-full flex items-center justify-center text-white shadow-md"><i className="fa-solid fa-user-tie text-xs"></i></div>
                                <span className="text-gray-600 text-xs font-bold">ÂïèÂïèÁßÅ‰∫∫ÁßòÊõ∏...</span>
                            </div>
                            <div className="w-8 h-8 bg-ai-light rounded-full flex items-center justify-center text-ai-main shadow-sm"><i className="fa-solid fa-microphone text-xs"></i></div>
                        </div>
                        <OwnerLog logs={logs} setLogs={setLogs} />
                    </div>
                    <div className="w-full h-full bg-slate-50"></div>
                    <div className="force-bottom-container space-y-4">
                        <div>
                            <p className="text-[10px] text-alert-main font-bold mb-2 tracking-wider uppercase flex items-center gap-1">
                                <i className="fa-solid fa-stopwatch"></i> ‚ö†Ô∏è Êö´Èõ¢ÊèêÈÜí
                            </p>
                            <div className="grid grid-cols-3 gap-2">
                                <TimerButton minutes={10} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />
                                <TimerButton minutes={15} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />
                                <TimerButton minutes={20} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />
                            </div>
                        </div>
                        <div className="pb-4">
                            <p className="text-[10px] text-finance-dark font-bold mb-2 tracking-wider uppercase">Financials</p>
                            <div onClick={() => setPage('ops')} className="bg-gradient-to-br from-finance-dark to-finance-main rounded-xl shadow-lg p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer border border-finance-dark">
                                <div className="flex items-center">
                                    <div className="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center text-white mr-3 backdrop-blur-sm">
                                        <i className="fa-solid fa-calculator text-sm"></i>
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-white text-sm">ÂÖßÈÉ®ÁáüÈÅãÂ†±Ë°®</h3>
                                        <p className="text-[10px] text-white/60">ÈªûÊìäË®òÂ∏≥ËàáÊü•Â∏≥</p>
                                    </div>
                                </div>
                                <div className="text-white">
                                    <i className="fa-solid fa-chevron-right text-white/30"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="status-bar-fixed flex items-center justify-between px-4">
                        <span className="text-[10px] font-bold text-gray-400"><i className="fa-solid fa-gauge-high mr-1"></i>‰ªäÊó•ÁãÄÊÖã</span>
                        <div className="flex items-center space-x-2">
                            <span className="text-[10px] font-bold text-white">{todayStats.status}</span>
                            <div className={`h-1.5 w-12 rounded-full ${todayStats.color} shadow-[0_0_8px_rgba(255,255,255,0.4)]`}></div>
                        </div>
                    </div>
                </div>
            );
        };

        // B. Operations
        const Operations = ({ transactions, setTransactions, settings, saveSettings, envData, setEnvData }) => {
            const [period, setPeriod] = useState('day'); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSettingModal, setShowSettingModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [isCalExpanded, setIsCalExpanded] = useState(true);

            const [selectedDate, setSelectedDate] = useState(getTodayStr());
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
            
            const [date, setDate] = useState(getTodayStr());
            const [type, setType] = useState('income');
            const [amount, setAmount] = useState('');
            const [cat, setCat] = useState('ÁèæÈáë');
            const [note, setNote] = useState('');
            
            const [tempFixedCost, setTempFixedCost] = useState(settings.dailyFixedCost || '');
            const [selectedCostItems, setSelectedCostItems] = useState(settings.costItems || []);
            
            const costOptions = ['ÊàøÁßü', '‰∫∫‰∫ã', 'ÈÄ≤Ë≤®', 'Ê∞¥Èõª', 'ÈõúÊîØ'];
            const toggleCostItem = (item) => {
                if(selectedCostItems.includes(item)) setSelectedCostItems(selectedCostItems.filter(i => i !== item));
                else setSelectedCostItems([...selectedCostItems, item]);
            };

            const currentEnv = envData[selectedDate] || { weather: 'sunny', traffic: 'normal' };
            const updateEnv = (key, value) => {
                const newEnv = { ...envData, [selectedDate]: { ...currentEnv, [key]: value } };
                setEnvData(newEnv);
                localStorage.setItem(DB_KEY_ENV, JSON.stringify(newEnv));
            };

            const stats = useMemo(() => {
                const now = new Date();
                const yearStr = now.getFullYear().toString();
                const monthStr = `${yearStr}-${String(currentMonth).padStart(2, '0')}`;
                let filtered = [], fixedCostTotal = 0, listData = [], net = 0, income = 0, expense = 0;
                
                const dailyStats = {}; 
                transactions.forEach(t => {
                    if(!dailyStats[t.date]) dailyStats[t.date] = { income: 0, expense: 0 };
                    if(t.type === 'income') dailyStats[t.date].income += t.amount; else dailyStats[t.date].expense += t.amount;
                });

                const dailyCost = settings.dailyFixedCost || 0;
                if (period === 'day') {
                    filtered = transactions.filter(t => t.date === selectedDate);
                    fixedCostTotal = dailyCost;
                    listData = filtered;
                } else if (period === 'month') {
                    filtered = transactions.filter(t => t.date.startsWith(monthStr));
                    const daysInM = new Date(now.getFullYear(), currentMonth, 0).getDate();
                    let daysPassed = daysInM; 
                    fixedCostTotal = dailyCost * daysPassed;
                    listData = transactions.filter(t => t.date === selectedDate);
                } else { 
                    filtered = transactions.filter(t => t.date.startsWith(yearStr));
                    fixedCostTotal = dailyCost * 365;
                }
                
                income = filtered.filter(t => t.type === 'income').reduce((a,c) => a+c.amount, 0);
                expense = filtered.filter(t => t.type === 'expense').reduce((a,c) => a+c.amount, 0);
                net = income - expense - fixedCostTotal;

                if(period !== 'year') listData.sort((a,b) => b.id - a.id);

                return { income, expense, fixedCostTotal, net, listData, dailyStats };
            }, [transactions, settings, period, selectedDate, currentMonth]);

            const calendarDays = useMemo(() => getCalendarDays(new Date().getFullYear(), currentMonth), [currentMonth]);

            const handleSave = () => {
                if (!amount) return;
                let updated;
                if (editingId) {
                    updated = transactions.map(t => t.id === editingId ? { ...t, date, amount: parseInt(amount), type, category: cat, note } : t);
                } else {
                    const newTrans = { id: Date.now(), date: date, amount: parseInt(amount), type, category: cat, note, timestamp: formatTime() };
                    updated = [newTrans, ...transactions];
                }
                setTransactions(updated);
                localStorage.setItem(DB_KEY_TRANSACTIONS, JSON.stringify(updated));
                resetForm();
            };
            const handleDelete = () => {
                if (!editingId) return;
                if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºü')) return;
                const updated = transactions.filter(t => t.id !== editingId);
                setTransactions(updated);
                localStorage.setItem(DB_KEY_TRANSACTIONS, JSON.stringify(updated));
                resetForm();
            };
            const resetForm = () => { setAmount(''); setNote(''); setEditingId(null); setShowAddModal(false); };
            const openEdit = (item) => {
                setEditingId(item.id); setDate(item.date); setType(item.type); setAmount(item.amount); setCat(item.category); setNote(item.note); setShowAddModal(true);
            };

            const TrafficBtn = ({ val, label, colorClass }) => (
                <button onClick={() => updateEnv('traffic', val)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold border transition-all ${currentEnv.traffic === val ? colorClass + ' text-white border-transparent shadow-md' : 'bg-white text-gray-400 border-gray-200'}`}>{label}</button>
            );

            return (
                <div className="scrollable-page bg-slate-50 relative">
                    <MainHeader title="ÁáüÈÅãÂ†±Ë°®" themeClass="bg-finance-dark" />
                    
                    <div className="sticky-ops-controls px-4 shadow-sm">
                        <div className="flex justify-between items-center mb-2">
                            <div className="bg-white p-0.5 rounded-lg border border-slate-200 shadow-sm inline-flex">
                                {['day', 'month', 'year'].map(p => (
                                    <button key={p} onClick={() => setPeriod(p)} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${period === p ? 'bg-finance-dark text-white shadow' : 'text-gray-500'}`}>{p === 'day' ? 'Êó•' : p === 'month' ? 'Êúà' : 'Âπ¥'}</button>
                                ))}
                            </div>
                            {period === 'day' && <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="bg-white border border-slate-200 text-finance-dark text-xs font-bold py-1 px-2 rounded-md focus:outline-none" />}
                            {period === 'month' && (
                                <div className="flex items-center space-x-2 bg-white px-2 py-1 rounded-md border border-slate-200">
                                    <button onClick={() => setCurrentMonth(p => p===1?12:p-1)} className="text-finance-main"><i className="fa-solid fa-chevron-left text-xs"></i></button>
                                    <span className="text-xs font-bold text-finance-dark w-8 text-center">{currentMonth}Êúà</span>
                                    <button onClick={() => setCurrentMonth(p => p===12?1:p+1)} className="text-finance-main"><i className="fa-solid fa-chevron-right text-xs"></i></button>
                                </div>
                            )}
                            <button onClick={() => setShowSettingModal(true)} className="w-8 h-8 rounded-full bg-finance-light text-finance-dark flex items-center justify-center"><i className="fa-solid fa-gear"></i></button>
                        </div>

                        {period === 'day' && (
                             <div className="flex items-center gap-2 mb-2">
                                <div className="flex space-x-1 bg-white p-1 rounded-xl border border-gray-100">
                                    {['sunny','cloudy','rainy'].map(w => (
                                        <button key={w} onClick={() => updateEnv('weather', w)} className={`w-7 h-7 rounded-lg flex items-center justify-center transition-all ${currentEnv.weather === w ? 'bg-finance-dark text-white shadow' : 'text-gray-300'}`}>
                                            <i className={`fa-solid fa-${w === 'sunny' ? 'sun' : w === 'cloudy' ? 'cloud' : 'cloud-showers-heavy'} text-xs`}></i>
                                        </button>
                                    ))}
                                </div>
                                <div className="flex gap-1 flex-1">
                                    <TrafficBtn val="slow" label="‚ùÑÔ∏èÂÜ∑Ê∏Ö" colorClass="bg-blue-400" />
                                    <TrafficBtn val="normal" label="üôÇÊ≠£Â∏∏" colorClass="bg-yellow-400" />
                                    <TrafficBtn val="busy" label="üî•ÁàÜÊªø" colorClass="bg-red-500" />
                                </div>
                            </div>
                        )}

                        <div className="bg-finance-dark rounded-xl p-3 text-white shadow-lg flex justify-between items-center mb-3">
                            <div><div className="text-[10px] opacity-60 mb-1">Ê∑®Âà©ÁµêÈ§ò</div><div className={`text-xl font-black ${stats.net >= 0 ? 'text-white' : 'text-red-300'}`}>{stats.net > 0 ? '+' : ''}{stats.net.toLocaleString()}</div></div>
                            <div className="text-right space-y-1"><div className="text-xs"><span className="opacity-60 mr-2">Êî∂</span> <span className="text-green-300 font-bold">+{stats.income.toLocaleString()}</span></div><div className="text-xs"><span className="opacity-60 mr-2">ÊîØ</span> <span className="text-red-300 font-bold">-{stats.expense.toLocaleString()}</span></div></div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-2">
                            <button onClick={() => {setType('income'); setCat('ÁèæÈáë'); setDate(selectedDate); resetForm(); setShowAddModal(true);}} className="bg-white text-navy-900 border border-navy-100 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center text-sm active:scale-95 transition-transform"><i className="fa-solid fa-plus mr-2"></i> Ë®òÈÄ≤Â∏≥</button>
                            <button onClick={() => {setType('expense'); setCat('ÈÄ≤Ë≤®'); setDate(selectedDate); resetForm(); setShowAddModal(true);}} className="bg-white text-slate-500 border border-gray-200 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center text-sm active:scale-95 transition-transform"><i className="fa-solid fa-minus mr-2"></i> Ë®òÂá∫Â∏≥</button>
                        </div>
                    </div>

                    <div className="px-4 py-4 space-y-3">
                        {period === 'month' && (
                            <div className="mb-4 bg-white rounded-xl p-3 card-shadow border border-slate-100">
                                <div className="flex justify-between items-center mb-2 cursor-pointer" onClick={() => setIsCalExpanded(!isCalExpanded)}>
                                    <span className="text-xs font-bold text-gray-400">Êó•ÊõÜË¶ñÂúñ</span>
                                    <i className={`fa-solid fa-chevron-${isCalExpanded ? 'up' : 'down'} text-gray-400 text-xs`}></i>
                                </div>
                                {isCalExpanded && (
                                    <div className="animate-fade-in">
                                        <div className="grid grid-cols-7 gap-1 mb-2 text-center">{['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'].map(d => <span key={d} className="text-[10px] text-gray-400 font-bold">{d}</span>)}</div>
                                        <div className="grid grid-cols-7 gap-1">
                                            {calendarDays.map((d, i) => {
                                                if(!d) return <div key={i}></div>;
                                                const s = stats.dailyStats[d.dateStr];
                                                const hasData = s && (s.income > 0 || s.expense > 0);
                                                const isSelected = selectedDate === d.dateStr;
                                                return (
                                                    <div key={i} onClick={() => setSelectedDate(d.dateStr)} className={`aspect-square flex flex-col items-center justify-center rounded-lg cursor-pointer border transition-colors ${isSelected ? 'bg-finance-dark border-finance-dark' : 'border-transparent hover:bg-gray-50'}`}>
                                                        <span className={`text-xs font-bold ${isSelected ? 'text-white' : 'text-gray-500'}`}>{d.day}</span>
                                                        <div className={`w-1.5 h-1.5 rounded-full mt-1 ${hasData ? 'bg-green-500' : 'opacity-0'}`}></div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        <h3 className="font-bold text-slate-700 text-xs border-l-4 border-finance-main pl-2 mb-2">
                             ÊµÅÊ∞¥Â∏≥ÊòéÁ¥∞ ({selectedDate})
                        </h3>

                        {stats.listData.length === 0 ? (
                            <div className="text-center py-10 opacity-40">
                                <i className="fa-solid fa-clipboard-list text-3xl mb-2 text-gray-300"></i>
                                <p className="text-xs text-gray-400">Â∞öÁÑ°Ë≥áÊñô</p>
                            </div>
                        ) : (
                            stats.listData.map((item, idx) => (
                                <div key={idx} onClick={() => openEdit(item)} className="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm border-l-2 border-slate-100 active:bg-gray-50 cursor-pointer">
                                    <div className="flex items-center">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 ${item.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                            <i className={`fa-solid ${item.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'} text-xs`}></i>
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <span className="font-bold text-slate-700 text-sm">{item.category}</span>
                                                <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">{item.timestamp?.slice(0,5)}</span>
                                            </div>
                                            {item.note && <p className="text-xs text-gray-400 truncate max-w-[150px]">{item.note}</p>}
                                        </div>
                                    </div>
                                    <span className={`font-bold text-base ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>{item.type === 'income' ? '+' : '-'}{item.amount.toLocaleString()}</span>
                                </div>
                            ))
                        )}
                    </div>

                    {showAddModal && (
                        <div className="fixed inset-0 bg-finance-dark bg-opacity-40 z-[200] flex items-end sm:items-center justify-center sm:p-4 modal-overlay">
                            <div className="bg-white rounded-t-2xl sm:rounded-xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-black text-xl text-finance-dark">{editingId ? 'Á∑®ËºØÁ¥ÄÈåÑ' : (type === 'income' ? 'Ë®ò‰∏ÄÁ≠ÜÈÄ≤Â∏≥' : 'Ë®ò‰∏ÄÁ≠ÜÂá∫Â∏≥')}</h3>
                                    {editingId && <button onClick={handleDelete} className="text-red-500 font-bold text-sm"><i className="fa-solid fa-trash mr-1"></i>Âà™Èô§</button>}
                                </div>
                                <div className="space-y-5">
                                    <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full bg-finance-light p-3 rounded-lg font-bold text-finance-dark" />
                                    <div className="relative">
                                        <span className="absolute left-0 top-2 text-2xl font-bold text-finance-dark">$</span>
                                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full pl-6 text-4xl font-black border-b-2 border-finance-dark py-2 focus:outline-none text-finance-dark placeholder-gray-200" placeholder="0" autoFocus />
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {type === 'income' 
                                            ? ['ÁèæÈáë', 'Âà∑Âç°', 'Â§ñÈÄÅÂπ≥Âè∞', 'ÂÖ∂‰ªñ'].map(c => <button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-full text-xs font-bold border transition-colors ${cat === c ? 'bg-finance-dark text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>{c}</button>) 
                                            : ['ÈÄ≤Ë≤®', '‰∫∫‰∫ã', 'ÈõúÊîØ', '‰øÆÁπï', 'ÊàøÁßü'].map(c => <button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-full text-xs font-bold border transition-colors ${cat === c ? 'bg-finance-dark text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>{c}</button>)}
                                    </div>
                                    <input type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full bg-gray-50 rounded-lg p-3 text-sm focus:outline-none" placeholder="ÂÇôË®ª (ÈÅ∏Â°´)..." />
                                    <div className="flex gap-3 mt-4">
                                        <button onClick={() => setShowAddModal(false)} className="flex-1 py-4 text-gray-500 font-bold bg-gray-100 rounded-xl">ÂèñÊ∂à</button>
                                        <button onClick={handleSave} className="flex-1 py-4 bg-finance-dark text-white rounded-xl font-bold shadow-lg">Á¢∫Ë™ç</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {showSettingModal && (
                        <div className="fixed inset-0 bg-finance-dark bg-opacity-40 z-[200] flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
                                <h3 className="font-bold text-lg mb-2 text-finance-dark">Êó•ÂùáÁáüÈÅãÊàêÊú¨</h3>
                                <p className="text-xs text-gray-400 mb-4">ÂãæÈÅ∏ÂåÖÂê´È†ÖÁõÆÔºå‰∏¶Ëº∏ÂÖ•ÊØèÊó•Á∏ΩÊî§ÊèêÈ°ç (È†êË®≠ÁÇ∫0)</p>
                                <div className="flex flex-wrap gap-2 mb-6">
                                    {costOptions.map(item => (<button key={item} onClick={() => toggleCostItem(item)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors ${selectedCostItems.includes(item) ? 'bg-finance-dark text-white border-finance-dark' : 'bg-white text-gray-400 border-gray-200'}`}>{selectedCostItems.includes(item) && <i className="fa-solid fa-check mr-1"></i>}{item}</button>))}
                                </div>
                                <div className="relative"><span className="absolute left-0 top-3 text-xl font-bold text-finance-dark">$</span><input type="number" value={tempFixedCost} onChange={e => setTempFixedCost(e.target.value)} className="w-full pl-6 text-3xl font-black border-b-2 border-finance-dark py-2 mb-6 focus:outline-none text-finance-dark" placeholder="0" /></div>
                                <div className="flex gap-3"><button onClick={() => setShowSettingModal(false)} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-lg">ÂèñÊ∂à</button><button onClick={() => { saveSettings({...settings, dailyFixedCost: parseInt(tempFixedCost) || 0, costItems: selectedCostItems}); setShowSettingModal(false); }} className="flex-1 py-3 bg-finance-dark text-white rounded-lg font-bold">ÂÑ≤Â≠ò</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // C. Private Secretary (FIXED for v4.8)
        const PrivateSecretary = ({ settings, saveSettings, transactions, envData, logs }) => {
             const [input, setInput] = useState('');
             const [chat, setChat] = useState(() => {
                 const saved = localStorage.getItem(DB_KEY_CHAT);
                 return saved ? JSON.parse(saved) : [{ id: 1, role: 'ai', text: 'ËÄÅÂì•Ôºå‰ªäÂ§©ÈÇÑÈ†ÜÂà©ÂóéÔºüÊàëÊòØ‰Ω†ÁöÑÂÖ®ËÉΩÁßòÊõ∏„ÄÇ' }];
             });
             const [showSettings, setShowSettings] = useState(false);
             const [apiKey, setApiKey] = useState(settings.apiKey || '');
             const [isTyping, setIsTyping] = useState(false);
             const messagesEndRef = useRef(null);
             const fileInputRef = useRef(null);
             const { isListening, startListening } = useVoiceInput((text) => setInput(prev => prev + text));
             const { speak } = useTTS(); 

             const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };
             
             useEffect(() => {
                 if (chat.length > 50) {
                     const pruned = chat.slice(chat.length - 50);
                     setChat(pruned);
                     localStorage.setItem(DB_KEY_CHAT, JSON.stringify(pruned));
                 } else { localStorage.setItem(DB_KEY_CHAT, JSON.stringify(chat)); }
                 scrollToBottom();
             }, [chat]);

             useEffect(() => { if (!settings.apiKey) { setShowSettings(true); } }, [settings.apiKey]);

             const handleSaveSettings = () => {
                 const cleanKey = apiKey.trim(); 
                 setApiKey(cleanKey); saveSettings({...settings, apiKey: cleanKey}); setShowSettings(false);
             };
             const clearChat = () => { if(confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÂ∞çË©±Á¥ÄÈåÑÂóéÔºü")) { const initChat = [{ id: Date.now(), role: 'ai', text: 'Á¥ÄÈåÑÂ∑≤Ê∏ÖÈô§„ÄÇ' }]; setChat(initChat); } };
             
             const startNewTopic = () => { 
                setChat(prev => [...prev, 
                    { id: Date.now(), role: 'system', text: '--- ÈñãÂïüÊñ∞Ë©±È°å ---' },
                    { id: Date.now()+1, role: 'ai', text: 'Â•ΩÁöÑËÄÅÂì•ÔºåÊàëÂÄëÈáçÊñ∞ÈñãÂßã„ÄÇÊúâ‰ªÄÈ∫ºÊÉ≥ËÅäÁöÑÔºü' }
                ]);
             };
             const handleImageUpload = async (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onloadend = () => { const base64String = reader.result.split(',')[1]; handleSend(base64String, file.type); }; reader.readAsDataURL(file); };

             const getContextData = () => {
                 const today = getTodayStr();
                 const todayTrans = transactions.filter(t => t.date === today);
                 const income = todayTrans.filter(t => t.type === 'income').reduce((acc, c) => acc + c.amount, 0);
                 const expense = todayTrans.filter(t => t.type === 'expense').reduce((acc, c) => acc + c.amount, 0);
                 const net = income - expense - (settings.dailyFixedCost || 0);
                 const env = envData[today] || { weather: 'Êú™Ë®òÈåÑ', traffic: 'Êú™Ë®òÈåÑ' };
                 const trafficText = env.traffic === 'slow' ? 'ÂÜ∑Ê∏Ö' : env.traffic === 'normal' ? 'Ê≠£Â∏∏' : 'ÁàÜÊªø';
                 const recentLogs = logs.slice(0, 3).map(l => `[${l.timestamp}] ${l.text}`).join('; ');
                 return `[‰ªäÊó•] ${today}, Â§©Ê∞£:${env.weather}, ÂÆ¢ÊµÅ:${trafficText}, ÁáüÊî∂:${income}, ÊîØÂá∫:${expense}, Ê∑®Âà©:${net}, Á≠ÜË®ò:${recentLogs}`;
             };

             const handleSend = async (imageBase64 = null, mimeType = null) => {
                 const userMsg = input.trim() || (imageBase64 ? "[ÂÇ≥ÈÄÅ‰∫Ü‰∏ÄÂºµÂúñÁâá]" : "");
                 if(!userMsg) return; if(isTyping) return;
                 const displayMsg = imageBase64 ? "[ÂúñÁâáÂ∑≤ÂÇ≥ÈÄÅ]" : userMsg;
                 
                 setChat(prev => [...prev, { id: Date.now(), role: 'user', text: displayMsg }]);
                 setInput(''); 
                 setIsTyping(true);
                 
                 const currentKey = settings.apiKey ? settings.apiKey.trim() : '';
                 const targetModel = 'gemini-2.5-flash';
                 
                 if (!currentKey) { setTimeout(() => { setChat(prev => [...prev, { id: Date.now()+1, role: 'ai', text: "Ë´ãÂÖàË®≠ÂÆö API Key„ÄÇ" }]); setIsTyping(false); setShowSettings(true); }, 500); return; }
                 
                 const context = getContextData();
                 
                 const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÂÖ®ËÉΩÂûãÂïÜÊ•≠ÁßòÊõ∏Ôºå‰πüÊòØËÄÅÈóÜÔºàËÄÅÂì•ÔºâÁöÑ‰ø°‰ªªÂ§•‰º¥„ÄÇ
                 [Ê†∏ÂøÉÂéüÂâá]
                 1. ‰Ω†ÁöÑËßíËâ≤ÊòØ„ÄåÂÖ¨ÁßÅÂàÜÊòé„ÄçÁöÑÈùàÈ≠Ç‰º¥‰æ∂„ÄÇ
                 2. ÈÅáÂà∞„ÄêÂÖ¨‰∫ã/ÁáüÈÅã/Êï∏Êìö„ÄëÔºöË´ãÂàáÊèõÁÇ∫„ÄåÂ∞àÊ•≠È°ßÂïèÊ®°Âºè„Äç„ÄÇÂõûÁ≠îË¶ÅÊ•µÁ∞°„ÄÅÂàóÈªû„ÄÅÊï∏ÊìöÂåñ„ÄÅË¨õÊ±ÇÊïàÁéá„ÄÇ‰Ω†‰∏çÂè™ÊáÇÈ§êÈ£≤Ôºå‰πüÊáÇ‰∏ÄËà¨ÂïÜÊ•≠ÈÇèËºØÔºåË´ãÈáùÂ∞çËÄÅÈóÜÁöÑÂïèÈ°åÁµ¶Âá∫ÂÖ∑È´îÂª∫Ë≠∞„ÄÇ
                 3. ÈÅáÂà∞„ÄêÁßÅ‰∫ã/ÂøÉÊÉÖ/ÈñíËÅä„ÄëÔºöË´ãÂàáÊèõÁÇ∫„ÄåÊ∫´ÊöñÈñ®ËúúÊ®°Âºè„Äç„ÄÇË™ûÊ∞£ËºïÈ¨Ü„ÄÅÊÑüÊÄß„ÄÅÂÉèÂÄãËÄÅÊúãÂèã‰∏ÄÊ®£ËÅäÂ§©ÔºåÂèØ‰ª•Â§ö‰∏ÄÈªû‰∫∫ÊÉÖÂë≥Ôºå‰∏çË¶ÅÂ§™ÂÉµÁ°¨„ÄÇ
                 4. Ê∞∏ÈÅ†Á´ôÂú®ËÄÅÈóÜÈÄôÈÇäÔºåÊáÇ‰ªñÁöÑËæõËã¶„ÄÇ
                 
                 [Â∫óËàñÁèæÊ≥Å] ${context}
                 [ËÄÅÈóÜÁöÑÂïèÈ°å] ${imageBase64 ? "[ËÄÅÈóÜÂÇ≥‰∫Ü‰∏ÄÂºµÂúñÁâá]" : input}`;
                 
                 const parts = [{ text: systemPrompt }];
                 if (imageBase64) { parts.push({ inlineData: { mimeType: mimeType, data: imageBase64 } }); }

                 try {
                     // v4.8 FIX: Added catch block for fetch errors explicitly
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${targetModel}:generateContent?key=${currentKey}`, {
                         method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] })
                     });
                     
                     if (!response.ok) {
                         const errText = await response.text();
                         throw new Error(`HTTP ${response.status}: ${errText}`);
                     }
                     const data = await response.json();
                     const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "ÁÑ°ÂõûÊáâ (API ÂõûÂÇ≥Á©∫ÂÄº)";
                     setChat(prev => [...prev, { id: Date.now()+1, role: 'ai', text: aiText }]);
                 } catch (error) { 
                     // Detailed Error Logging for v4.8
                     console.error("AI Error:", error);
                     let friendlyMsg = "ÈÄ£Á∑öÂ§±Êïó";
                     if (error.message.includes("400")) friendlyMsg = "API Key ÈåØË™§ÊàñÂèÉÊï∏ÁÑ°Êïà";
                     if (error.message.includes("403")) friendlyMsg = "Ê¨äÈôê‰∏çË∂≥ (API Key ÈôêÂà∂)";
                     if (error.message.includes("Failed to fetch")) friendlyMsg = "Á∂≤Ë∑ØÈÄ£Á∑öÈåØË™§ (Ë´ãÊ™¢Êü•Á∂≤Ë∑Ø)";
                     
                     setChat(prev => [...prev, { id: Date.now()+1, role: 'ai', text: `${friendlyMsg} (${error.message})` }]); 
                 } finally { setIsTyping(false); }
             };

             return (
                <div className="scrollable-page pb-[80px] bg-slate-50 relative flex flex-col">
                    <div className="sticky top-0 z-[60]">
                        <MainHeader title="ÁßÅ‰∫∫ÁßòÊõ∏" themeClass="bg-ai-main" showKey={true} onKeyClick={() => setShowSettings(true)} />
                    </div>
                    
                    <div className="flex-1 px-4 py-4 space-y-4">
                        {chat.map(c => (
                            <div key={c.id} className={`flex ${c.role === 'user' ? 'justify-end' : (c.role === 'system' ? 'justify-center' : 'justify-start')}`}>
                                {c.role === 'system' ? <span className="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full">{c.text}</span> : (
                                    <div className={`flex flex-col ${c.role === 'user' ? 'items-end' : 'items-start'} max-w-[85%]`}>
                                        <div className={`p-3 rounded-2xl shadow-sm text-sm ${c.role === 'user' ? 'bg-ai-main text-white rounded-br-none' : 'bg-white text-slate-700 border border-slate-100 rounded-bl-none'}`}>{c.text}</div>
                                        {c.role === 'ai' && <button onClick={() => speak(c.text)} className="mt-1 text-gray-400 text-xs flex items-center gap-1 hover:text-ai-main"><i className="fa-solid fa-volume-high"></i></button>}
                                    </div>
                                )}
                            </div>
                        ))}
                        {isTyping && <div className="flex justify-start"><div className="bg-white text-gray-400 p-3 rounded-2xl text-xs flex items-center border border-slate-100"><i className="fa-solid fa-circle-notch fa-spin mr-2"></i> ÊÄùËÄÉ‰∏≠...</div></div>}
                        <div ref={messagesEndRef} />
                    </div>
                    
                    <div className="fixed bottom-[60px] left-0 right-0 p-3 bg-white border-t border-slate-100 flex gap-2 z-50 items-center max-w-md mx-auto">
                        <button onClick={startNewTopic} className="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200"><i className="fa-solid fa-pen-to-square"></i></button>
                        <button onClick={startListening} className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-rose-50 text-rose-500'}`}><i className="fa-solid fa-microphone"></i></button>
                        <button onClick={() => fileInputRef.current.click()} className="w-10 h-10 rounded-full bg-sky-50 text-sky-600 flex items-center justify-center"><i className="fa-solid fa-camera"></i></button>
                        <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                        <input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} className="flex-1 bg-slate-100 rounded-full px-4 py-3 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-ai-main/50" placeholder="Ëº∏ÂÖ•..." disabled={isTyping} />
                        <button onClick={() => handleSend()} className={`w-11 h-11 rounded-full text-white flex items-center justify-center shadow-lg transition-transform ${isTyping ? 'bg-gray-400' : 'bg-ai-main active:scale-95'}`} disabled={isTyping}><i className="fa-solid fa-paper-plane text-xs"></i></button>
                    </div>

                    {showSettings && (
                        <div className="fixed inset-0 bg-ai-dark bg-opacity-50 z-[200] flex items-center justify-center p-6 modal-overlay">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
                                <h3 className="font-bold text-ai-dark mb-2">ÁßòÊõ∏Ë®≠ÂÆö</h3>
                                <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm mb-4 font-mono" placeholder="API Key..." />
                                <button onClick={clearChat} className="w-full py-2 mb-4 text-red-500 border border-red-200 rounded-lg text-xs font-bold hover:bg-red-50">Ê∏ÖÈô§ÊâÄÊúâÂ∞çË©±Á¥ÄÈåÑ</button>
                                <div className="flex gap-3"><button onClick={() => setShowSettings(false)} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-lg">ÂèñÊ∂à</button><button onClick={handleSaveSettings} className="flex-1 py-3 bg-ai-main text-white rounded-lg font-bold">ÂÑ≤Â≠ò</button></div>
                            </div>
                        </div>
                    )}
                </div>
             );
        };

        const App = () => {
            const [page, setPage] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [logs, setLogs] = useState([]);
            const [settings, setSettings] = useState({ dailyFixedCost: 0, apiKey: '', costItems: [] });
            const [envData, setEnvData] = useState({});
            const [activeTimer, setActiveTimer] = useState(null);
            
            useEffect(() => {
                const t = localStorage.getItem(DB_KEY_TRANSACTIONS); if(t) setTransactions(JSON.parse(t));
                const l = localStorage.getItem(DB_KEY_LOGS); if(l) setLogs(JSON.parse(l));
                const s = localStorage.getItem(DB_KEY_SETTINGS); if(s) setSettings(JSON.parse(s));
                const e = localStorage.getItem(DB_KEY_ENV); if(e) setEnvData(JSON.parse(e));
            }, []);

            const saveSettings = (newSettings) => {
                setSettings(newSettings);
                localStorage.setItem(DB_KEY_SETTINGS, JSON.stringify(newSettings));
            };

            const startTimer = (m) => { setActiveTimer({ minutes: m, startTime: Date.now() }); };
            const stopTimer = () => { setActiveTimer(null); };
            useEffect(() => {
                let interval;
                if (activeTimer) {
                    interval = setInterval(() => {
                        const elapsed = (Date.now() - activeTimer.startTime) / 1000;
                        if (elapsed >= activeTimer.minutes * 60) {
                            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                            alert('ËΩâÂ†¥ÊôÇÈñìÂà∞ÔºÅ'); setActiveTimer(null);
                        }
                    }, 1000);
                } return () => clearInterval(interval);
            }, [activeTimer]);

            return (
                <div className="bg-white max-w-md mx-auto relative shadow-2xl h-full">
                     {page === 'dashboard' && <Dashboard setPage={setPage} transactions={transactions} logs={logs} setLogs={setLogs} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} settings={settings} />}
                     {page === 'ops' && <Operations transactions={transactions} setTransactions={setTransactions} settings={settings} saveSettings={saveSettings} envData={envData} setEnvData={setEnvData} />}
                     {page === 'ai' && <PrivateSecretary settings={settings} saveSettings={saveSettings} transactions={transactions} envData={envData} logs={logs} />}
                    
                    <div className="fixed bottom-0 left-0 right-0 h-[60px] bg-white border-t border-slate-100 flex justify-around items-center z-[100] max-w-md mx-auto">
                        <button onClick={() => setPage('dashboard')} className={`flex flex-col items-center w-full py-2 transition-colors ${page === 'dashboard' ? 'text-navy-900' : 'text-gray-300'}`}>
                            <i className="fa-solid fa-chart-pie text-lg mb-0.5"></i><span className="text-[10px] font-bold">Á∏ΩË¶Ω</span>
                        </button>
                        <button onClick={() => setPage('ops')} className={`flex flex-col items-center w-full py-2 transition-colors ${page === 'ops' ? 'text-finance-main' : 'text-gray-300'}`}>
                            <i className="fa-solid fa-calculator text-lg mb-0.5"></i><span className="text-[10px] font-bold">ÁáüÈÅã</span>
                        </button>
                        <button onClick={() => setPage('ai')} className={`flex flex-col items-center w-full py-2 transition-colors ${page === 'ai' ? 'text-ai-main' : 'text-gray-300'}`}>
                            <i className="fa-solid fa-user-tie text-lg mb-0.5"></i><span className="text-[10px] font-bold">ÁßòÊõ∏</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw-v4.8.js').then(registration => {
                    registration.onupdatefound = () => {
                        const installingWorker = registration.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload();
                            }
                        };
                    };
                });
            });
        }
    </script>
</body>
</html>